{% extends "base.html" %}

{% block title %}Feedback Dashboard | GT Tour Admin{% endblock %}

{% block extra_head %}
<style>
body {
    overflow: auto !important;
}
main {
    overflow: visible !important;
}
.feedback-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}
.filter-section {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
}
.filter-form {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: flex-end;
}
.filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}
.filter-group label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #666;
}
.filter-group select,
.filter-group input {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.875rem;
    min-width: 150px;
}
.filter-btn {
    padding: 0.5rem 1rem;
    background: #003057;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.filter-btn:hover {
    background: #002244;
}
.clear-btn {
    padding: 0.5rem 1rem;
    background: #f0f0f0;
    color: #333;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
}
.clear-btn:hover {
    background: #e0e0e0;
}
.feedback-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}
.feedback-card {
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
}
.feedback-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    cursor: pointer;
}
.feedback-header:hover {
    background: #f0f0f0;
}
.feedback-meta {
    display: flex;
    gap: 1rem;
    align-items: center;
}
.feedback-user {
    font-weight: 600;
}
.feedback-date {
    color: #666;
    font-size: 0.875rem;
}
.feedback-location {
    font-size: 0.875rem;
}
.feedback-location a {
    color: #003057;
    text-decoration: none;
}
.feedback-location a:hover {
    text-decoration: underline;
}
.star-rating {
    color: #fbbf24;
    font-size: 1rem;
}
.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}
.status-new {
    background: #fef3c7;
    color: #92400e;
}
.status-reviewed {
    background: #dbeafe;
    color: #1e40af;
}
.status-resolved {
    background: #d1fae5;
    color: #065f46;
}
.feedback-body {
    padding: 1rem;
    display: none;
}
.feedback-body.expanded {
    display: block;
}
.feedback-comment {
    margin-bottom: 1rem;
    line-height: 1.6;
}
.admin-response-section {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
}
.admin-response-section h4 {
    margin: 0 0 0.5rem 0;
    font-size: 0.875rem;
    color: #666;
}
.existing-response {
    background: #e0f2fe;
    padding: 1rem;
    border-radius: 4px;
    margin-bottom: 1rem;
}
.existing-response p {
    margin: 0 0 0.5rem 0;
}
.existing-response .response-meta {
    font-size: 0.75rem;
    color: #666;
}
.response-form {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}
.response-form textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: inherit;
    font-size: 0.875rem;
    resize: vertical;
    min-height: 100px;
}
.response-form-actions {
    display: flex;
    gap: 1rem;
    align-items: center;
}
.response-form select {
    padding: 0.5rem;
    border: 1px solid #ddd;
    border-radius: 4px;
}
.submit-response-btn {
    padding: 0.5rem 1rem;
    background: #003057;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}
.submit-response-btn:hover {
    background: #002244;
}
.submit-response-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
}
.pagination {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 2rem;
}
.pagination a,
.pagination span {
    padding: 0.5rem 1rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    text-decoration: none;
    color: #333;
}
.pagination a:hover {
    background: #f0f0f0;
}
.pagination .current {
    background: #003057;
    color: white;
    border-color: #003057;
}
.empty-state {
    text-align: center;
    padding: 3rem;
    color: #666;
}
.expand-icon {
    transition: transform 0.2s;
}
.feedback-card.expanded .expand-icon {
    transform: rotate(180deg);
}
</style>
{% endblock %}

{% block content %}
<div class="feedback-container">
    <h1 style="margin-bottom: 1.5rem;">Feedback Dashboard</h1>

    <div class="filter-section">
        <form method="get" class="filter-form">
            <div class="filter-group">
                <label for="status">Status</label>
                <select name="status" id="status">
                    <option value="">All Statuses</option>
                    {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="location">Location</label>
                <select name="location" id="location">
                    <option value="">All Locations</option>
                    {% for loc in locations %}
                    <option value="{{ loc.slug }}" {% if location_filter == loc.slug %}selected{% endif %}>{{ loc.name }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-group">
                <label for="date_from">From Date</label>
                <input type="date" name="date_from" id="date_from" value="{{ date_from }}">
            </div>

            <div class="filter-group">
                <label for="date_to">To Date</label>
                <input type="date" name="date_to" id="date_to" value="{{ date_to }}">
            </div>

            <button type="submit" class="filter-btn">Apply Filters</button>
            <a href="{% url 'campus:feedback_dashboard' %}" class="clear-btn">Clear</a>
        </form>
    </div>

    {% if page_obj.object_list %}
    <div class="feedback-list">
        {% for rating in page_obj %}
        <div class="feedback-card" data-rating-id="{{ rating.id }}">
            <div class="feedback-header" onclick="toggleFeedback({{ rating.id }})">
                <div class="feedback-meta">
                    <span class="feedback-user">{{ rating.user.username }}</span>
                    <span class="feedback-date">{{ rating.created_at|date:"M d, Y H:i" }}</span>
                    <span class="feedback-location">
                        <a href="{% url 'campus:location-detail' rating.location.slug %}">{{ rating.location.name }}</a>
                    </span>
                    <span class="star-rating">
                        {% for i in "12345" %}
                            {% if forloop.counter <= rating.score %}&#9733;{% else %}&#9734;{% endif %}
                        {% endfor %}
                    </span>
                </div>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span class="status-badge status-{{ rating.status }}">{{ rating.get_status_display }}</span>
                    <svg class="expand-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </div>
            </div>
            <div class="feedback-body" id="feedback-body-{{ rating.id }}">
                {% if rating.comment %}
                <div class="feedback-comment">
                    <strong>User Comment:</strong>
                    <p>{{ rating.comment }}</p>
                </div>
                {% else %}
                <p style="color: #666; font-style: italic;">No comment provided.</p>
                {% endif %}

                <div class="admin-response-section">
                    <h4>Admin Response</h4>
                    {% if rating.admin_response %}
                    <div class="existing-response" id="existing-response-{{ rating.id }}">
                        <p>{{ rating.admin_response }}</p>
                        <div class="response-meta">
                            Responded by {{ rating.responded_by.username }} on {{ rating.responded_at|date:"M d, Y H:i" }}
                        </div>
                    </div>
                    {% endif %}

                    <div class="response-form">
                        <textarea id="response-text-{{ rating.id }}" placeholder="{% if rating.admin_response %}Update your response...{% else %}Write a response to this feedback...{% endif %}">{{ rating.admin_response }}</textarea>
                        <div class="response-form-actions">
                            <label for="status-select-{{ rating.id }}">Status:</label>
                            <select id="status-select-{{ rating.id }}">
                                {% for value, label in status_choices %}
                                <option value="{{ value }}" {% if rating.status == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="submit-response-btn" onclick="submitResponse({{ rating.id }})">
                                {% if rating.admin_response %}Update Response{% else %}Submit Response{% endif %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if page_obj.has_other_pages %}
    <div class="pagination">
        {% if page_obj.has_previous %}
        <a href="?page={{ page_obj.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if location_filter %}&location={{ location_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">Previous</a>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <span class="current">{{ num }}</span>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <a href="?page={{ num }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if location_filter %}&location={{ location_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">{{ num }}</a>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if location_filter %}&location={{ location_filter }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">Next</a>
        {% endif %}
    </div>
    {% endif %}

    {% else %}
    <div class="empty-state">
        <p>No feedback found matching your filters.</p>
    </div>
    {% endif %}
</div>

<script>
function toggleFeedback(ratingId) {
    const card = document.querySelector(`[data-rating-id="${ratingId}"]`);
    const body = document.getElementById(`feedback-body-${ratingId}`);
    card.classList.toggle('expanded');
    body.classList.toggle('expanded');
}

async function submitResponse(ratingId) {
    const responseText = document.getElementById(`response-text-${ratingId}`).value.trim();
    const status = document.getElementById(`status-select-${ratingId}`).value;
    const btn = event.target;

    if (!responseText && !status) {
        showToast('Please provide a response or update the status.', 'error');
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Submitting...';

    try {
        const response = await fetch(`/campus/admin/feedback/${ratingId}/respond/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                response: responseText,
                status: status,
            }),
        });

        const data = await response.json();

        if (response.ok && data.success) {
            showToast('Response submitted successfully!', 'success');

            const card = document.querySelector(`[data-rating-id="${ratingId}"]`);
            const badge = card.querySelector('.status-badge');
            badge.className = `status-badge status-${data.status}`;
            badge.textContent = data.status.charAt(0).toUpperCase() + data.status.slice(1);

            const existingResponse = document.getElementById(`existing-response-${ratingId}`);
            if (existingResponse) {
                existingResponse.querySelector('p').textContent = data.admin_response;
                existingResponse.querySelector('.response-meta').textContent =
                    `Responded by ${data.responded_by} on ${new Date(data.responded_at).toLocaleString()}`;
            } else if (data.admin_response) {
                const responseSection = card.querySelector('.admin-response-section');
                const newResponseDiv = document.createElement('div');
                newResponseDiv.className = 'existing-response';
                newResponseDiv.id = `existing-response-${ratingId}`;
                newResponseDiv.innerHTML = `
                    <p>${data.admin_response}</p>
                    <div class="response-meta">
                        Responded by ${data.responded_by} on ${new Date(data.responded_at).toLocaleString()}
                    </div>
                `;
                responseSection.insertBefore(newResponseDiv, responseSection.querySelector('.response-form'));
            }

            btn.textContent = 'Update Response';
        } else {
            showToast(data.error || 'Failed to submit response.', 'error');
            btn.textContent = 'Submit Response';
        }
    } catch (error) {
        console.error('Error submitting response:', error);
        showToast('An error occurred. Please try again.', 'error');
        btn.textContent = 'Submit Response';
    } finally {
        btn.disabled = false;
    }
}
</script>
{% endblock %}
