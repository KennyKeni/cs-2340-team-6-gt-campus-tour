{% extends "base.html" %}

{% block title %}Campus Overview | GT Tour{% endblock %}

{% block content %}
<div class="campus-layout">
    <section class="panel side-panel" aria-labelledby="explore-heading">
        <header id="explore-heading" class="panel-heading">Explore Georgia Tech</header>
        <div class="sidebar-controls">
            <label class="visually-hidden" for="sidebar-view">Select view</label>
            <select id="sidebar-view" class="sidebar-select" aria-label="Choose content to display">
                <option value="locations" selected>Locations</option>
                <option value="tours">Tours</option>
            </select>
            <div class="sidebar-search">
                <label class="visually-hidden" for="location-search">Search locations</label>
                <input id="location-search" type="search" placeholder="Search locations..." autocomplete="off">
            </div>
        </div>
        <div id="location-list-section" class="sidebar-content" aria-live="polite">
            <div id="location-list-view" class="location-list-view">
                <p class="sidebar-support-text">Browse campus highlights and tap markers on the map to learn more.</p>
                <div id="location-items" class="location-list">
                {% for location in locations %}
                <article class="location-card"
                    data-name="{{ location.name|lower }}"
                    data-category="{{ location.category|default_if_none:''|lower }}"
                    data-address="{{ location.address|default_if_none:''|lower }}"
                    data-description="{{ location.description|lower }}"
                    data-slug="{{ location.slug }}"
                    data-display-name="{{ location.name|escape }}"
                    data-display-category="{{ location.category|default:"Campus Highlight"|escape }}"
                    data-display-address="{{ location.address|default_if_none:''|escape }}"
                    data-display-description="{{ location.description|escape }}"
                    data-detail-url="{% url 'campus:location-detail' location.slug %}"
                    data-image="{% if location.photo %}{{ location.photo.url }}{% elif location.image_url %}{{ location.image_url }}{% endif %}"
                    data-bookmarked="{% if location.slug in bookmarked_slugs %}true{% else %}false{% endif %}"
                    role="button"
                    tabindex="0">
                    <div class="location-card-header">
                        <div>
                            <h3 class="location-title">{{ location.name }}</h3>
                            <p class="location-meta">{{ location.category|default:"Campus Highlight" }}</p>
                        </div>
                        {% if user.is_authenticated %}
                        <button class="bookmark-btn"
                                data-slug="{{ location.slug }}"
                                data-bookmarked="{% if location.slug in bookmarked_slugs %}true{% else %}false{% endif %}"
                                aria-label="Bookmark {{ location.name }}"
                                title="{% if location.slug in bookmarked_slugs %}Remove bookmark{% else %}Add bookmark{% endif %}">
                            <svg class="bookmark-icon {% if location.slug in bookmarked_slugs %}bookmarked{% endif %}"
                                 width="20" height="20" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                </article>
                {% endfor %}
                </div>
                <p id="location-empty" class="sidebar-empty" hidden>No locations match your search.</p>
            </div>
            <div id="location-detail-view" class="location-detail-view" hidden>
                <button type="button" id="location-detail-back" class="location-detail-back" aria-label="Back to locations">← Back to locations</button>
                <div id="location-detail-content" class="location-detail-content" aria-live="polite"></div>
            </div>
        </div>
        <div id="tour-list-section" class="sidebar-content" aria-live="polite" hidden>
            {% if user.is_authenticated %}
                <div class="tour-list-header">
                    <a href="{% url 'campus:tour-create' %}" class="create-tour-btn">+ Create Tour</a>
                </div>
                <div id="tour-items" class="tour-list">
                    {% for tour in tours %}
                    <article class="tour-card" data-tour-id="{{ tour.id }}">
                        <div class="tour-card-header">
                            <h3 class="tour-title">{{ tour.name }}</h3>
                            <div class="tour-card-actions">
                                <button type="button" class="tour-toggle" data-tour-id="{{ tour.id }}" aria-label="Toggle tour details">▼</button>
                            </div>
                        </div>
                        <div class="tour-details" id="tour-details-{{ tour.id }}" hidden>
                            {% if tour.description %}
                            <p class="tour-description">{{ tour.description }}</p>
                            {% endif %}
                            <p class="tour-stops-count">{{ tour.stops.count }} stop{{ tour.stops.count|pluralize }}</p>
                            <button type="button" class="view-tour-btn" data-tour-id="{{ tour.id }}">View on Map</button>
                        </div>
                    </article>
                    {% empty %}
                    <p class="sidebar-empty">No tours yet. <a href="{% url 'campus:tour-create' %}">Create your first tour</a>!</p>
                    {% endfor %}
                </div>
            {% else %}
                <p class="sidebar-placeholder">Please <a href="{% url 'accounts:login' %}">login</a> to create and view tours.</p>
            {% endif %}
        </div>
    </section>
    <section class="panel map-panel" aria-labelledby="map-heading">
        <header id="map-heading" class="panel-heading">Campus Map</header>
        {% if not google_maps_api_key %}
        <div style="padding: 1rem; background: #fee2e2; border: 1px solid #fca5a5; border-radius: 4px; margin: 1rem;">
            <p style="margin: 0; color: #991b1b;"><strong>Map unavailable:</strong> Missing Google Maps API key. Please add <code>GOOGLE_MAP_API_KEY=your_key_here</code> to your .env file and restart the server.</p>
        </div>
        {% endif %}
        <div id="campus-map" class="map-canvas" role="application" aria-label="Georgia Tech campus map">
        </div>
    </section>
    <section class="panel chat-panel" aria-labelledby="chat-heading">
        <header id="chat-heading" class="panel-heading">Ask About Landmarks</header>
        <div id="chat-history" class="chat-history" aria-live="polite">
        </div>
        <form id="chat-form" class="chat-input" novalidate>
            <label for="chat-message" class="visually-hidden">Ask a question about campus landmarks</label>
            <textarea id="chat-message" name="message" placeholder="Ask about a building or landmark..." required></textarea>
            <button type="submit" id="chat-submit">Send</button>
        </form>
    </section>
</div>
{% endblock %}

{% block extra_body %}
{{ locations_payload|json_script:"initial-location-data" }}
{{ map_center|json_script:"map-center-data" }}
<script>
    const locationData = JSON.parse(document.getElementById('initial-location-data').textContent);
    const mapCenter = JSON.parse(document.getElementById('map-center-data').textContent);
    let map;

    function createInfoWindowContent(location) {
        const addressLine = location.address ? `<p><strong>Address:</strong> ${location.address}</p>` : '';
        const categoryLine = location.category ? `<p><strong>Category:</strong> ${location.category}</p>` : '';

        const photoUrl = location.photo || location.image_url;
        console.log('Photo URL for', location.name, ':', photoUrl);
        const photoLine = photoUrl ? `
            <div style="margin-bottom: 0.75rem;">
                <img src="${photoUrl}"
                     alt="${location.name}"
                     style="width: 100%; max-width: 300px; height: auto; border-radius: 8px; display: block; object-fit: cover;"
                     onerror="console.error('Failed to load image:', this.src); this.style.display='none';"
                     onload="console.log('Image loaded successfully:', this.src)">
            </div>
        ` : '';

        return `
            <div style="max-width: 320px;">
                ${photoLine}
                <h3 style="margin: 0 0 0.5rem; font-size: 1.1rem;">${location.name}</h3>
                ${categoryLine}
                ${addressLine}
                <p style="margin: 0.5rem 0;">${location.description}</p>
            </div>
        `;
    }

    window.initCampusMap = function initCampusMap() {
        const mapElement = document.getElementById('campus-map');
        if (!mapElement) {
            return;
        }
        const adjustedCenter = {
            lat: mapCenter.lat - 0.0015,
            lng: mapCenter.lng,
        };

        map = new google.maps.Map(mapElement, {
            center: adjustedCenter,
            zoom: 17,
            disableDefaultUI: false,
            zoomControl: true,
            streetViewControl: true,
            fullscreenControl: true,
            mapTypeControl: true,
            draggable: true,
            scrollwheel: true,
            disableDoubleClickZoom: false,
            keyboardShortcuts: true,
            gestureHandling: 'auto',
            styles: [
                { featureType: 'poi', elementType: 'labels.icon', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi', elementType: 'labels.text', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi', elementType: 'geometry', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi.business', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi.park', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi.school', stylers: [{ visibility: 'off' }] },
                { featureType: 'transit', stylers: [{ visibility: 'off' }] },
            ],
        });

        const infoWindow = new google.maps.InfoWindow();

        locationData.forEach((location) => {
            const marker = new google.maps.Marker({
                position: { lat: location.latitude, lng: location.longitude },
                map,
                title: location.name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 7,
                    fillColor: '#fbbf24',
                    fillOpacity: 1,
                    strokeColor: '#003057',
                    strokeWeight: 2,
                },
            });

            marker.addListener('click', () => {
                infoWindow.setContent(createInfoWindowContent(location));
                infoWindow.open(map, marker);

                const locationCard = document.querySelector(`.location-card[data-slug="${location.slug}"]`);
                if (locationCard) {
                    const viewSelect = document.getElementById('sidebar-view');
                    if (viewSelect && viewSelect.value !== 'locations') {
                        viewSelect.value = 'locations';
                        viewSelect.dispatchEvent(new Event('change'));
                    }

                    locationCard.click();
                    locationCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    const currentLocationMarker = new google.maps.Marker({
                        position: currentLocation,
                        map,
                        title: 'Your Current Location',
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10,
                            fillColor: '#4285F4',
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 3,
                        },
                        zIndex: 1000
                    });

                    const currentLocationInfoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 0.5rem;">
                                <h3 style="margin: 0 0 0.5rem; font-size: 1rem; color: #4285F4;">Your Current Location</h3>
                                <p style="margin: 0; font-size: 0.9rem;">Latitude: ${currentLocation.lat.toFixed(6)}</p>
                                <p style="margin: 0; font-size: 0.9rem;">Longitude: ${currentLocation.lng.toFixed(6)}</p>
                            </div>
                        `
                    });

                    currentLocationMarker.addListener('click', () => {
                        currentLocationInfoWindow.open(map, currentLocationMarker);
                    });
                },
                (error) => {
                    console.warn('Error getting current location:', error.message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        }
    };
</script>
<script>
    (function () {
        const viewSelect = document.getElementById('sidebar-view');
        const searchInput = document.getElementById('location-search');
        const locationSection = document.getElementById('location-list-section');
        const toursSection = document.getElementById('tour-list-section');
        const locationListView = document.getElementById('location-list-view');
        const locationDetailView = document.getElementById('location-detail-view');
        const locationDetailContent = document.getElementById('location-detail-content');
        const locationDetailBack = document.getElementById('location-detail-back');
        const locationContainer = document.getElementById('location-items');
        const emptyState = document.getElementById('location-empty');
        const userIsAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
        const loginUrl = "{% url 'accounts:login' %}";
        const csrfToken = "{{ csrf_token }}";
        const locationItems = locationContainer ? Array.from(locationContainer.querySelectorAll('.location-card')) : [];
        let lastFocusedSlug = null;

        if (!viewSelect || !searchInput || !locationSection || !toursSection || !locationContainer) {
            return;
        }

        const escapeHtml = (value = '') => String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

        const formatText = (value = '') => escapeHtml(value).replace(/\n/g, '<br>');

        function updateEmptyState(visibleCount) {
            if (!emptyState) {
                return;
            }

            if (locationListView && locationListView.hidden) {
                emptyState.hidden = true;
                return;
            }

            emptyState.hidden = visibleCount > 0;
        }

        function applyFilter() {
            const query = searchInput.value.trim().toLowerCase();
            let visibleCount = 0;

            locationItems.forEach((item) => {
                const haystack = [
                    item.dataset.name,
                    item.dataset.category,
                    item.dataset.address,
                    item.dataset.description,
                ].join(' ');

                const matches = !query || haystack.includes(query);
                item.hidden = !matches;
                if (matches) {
                    visibleCount += 1;
                }
            });

            updateEmptyState(visibleCount);
        }

        function reorderLocationCards() {
            if (!locationContainer) {
                return;
            }

            const cards = Array.from(locationContainer.querySelectorAll('.location-card'));
            const bookmarkedCards = cards.filter((card) => card.dataset.bookmarked === 'true');
            const unbookmarkedCards = cards.filter((card) => card.dataset.bookmarked !== 'true');

            unbookmarkedCards.sort((a, b) => a.dataset.name.localeCompare(b.dataset.name));

            locationContainer.innerHTML = '';
            bookmarkedCards.forEach((card) => locationContainer.appendChild(card));
            unbookmarkedCards.forEach((card) => locationContainer.appendChild(card));

            const visibleCount = locationItems.reduce((count, item) => count + (item.hidden ? 0 : 1), 0);
            updateEmptyState(visibleCount);
        }

        function updateBookmarkUI(slug, isBookmarked, { sourceButton } = {}) {
            const bookmarkValue = isBookmarked ? 'true' : 'false';
            const card = locationContainer.querySelector(`.location-card[data-slug="${slug}"]`);
            const cardName = card?.dataset.displayName || '';

            if (card) {
                card.dataset.bookmarked = bookmarkValue;
                const cardButton = card.querySelector('.bookmark-btn');
                if (cardButton) {
                    cardButton.dataset.bookmarked = bookmarkValue;
                    cardButton.title = isBookmarked ? 'Remove bookmark' : 'Add bookmark';
                    cardButton.setAttribute('aria-label', `${isBookmarked ? 'Remove bookmark for ' : 'Bookmark '}${cardName}`);
                    const cardIcon = cardButton.querySelector('.bookmark-icon');
                    if (cardIcon) {
                        cardIcon.classList.toggle('bookmarked', isBookmarked);
                    }
                }

                if (isBookmarked && locationContainer.firstChild !== card) {
                    locationContainer.insertBefore(card, locationContainer.firstChild);
                }
            }

            const detailButton = locationDetailContent.querySelector(`.bookmark-btn[data-slug="${slug}"]`);
            if (detailButton) {
                detailButton.dataset.bookmarked = bookmarkValue;
                detailButton.title = isBookmarked ? 'Remove bookmark' : 'Add bookmark';
                const detailIcon = detailButton.querySelector('.bookmark-icon');
                if (detailIcon) {
                    detailIcon.classList.toggle('bookmarked', isBookmarked);
                    detailIcon.setAttribute('fill', isBookmarked ? 'currentColor' : 'none');
                }
                const label = detailButton.querySelector('.bookmark-label');
                if (label) {
                    label.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
                }
                const detailName = cardName || detailButton.dataset.name || '';
                detailButton.setAttribute('aria-label', `${isBookmarked ? 'Remove bookmark for ' : 'Bookmark '}${detailName}`);
            }

            if (sourceButton && sourceButton !== detailButton && (!card || sourceButton !== card.querySelector('.bookmark-btn'))) {
                const icon = sourceButton.querySelector('.bookmark-icon');
                if (icon) {
                    icon.classList.toggle('bookmarked', isBookmarked);
                    icon.setAttribute('fill', isBookmarked ? 'currentColor' : 'none');
                }
                const label = sourceButton.querySelector('.bookmark-label');
                if (label) {
                    label.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
                }
                sourceButton.dataset.bookmarked = bookmarkValue;
                sourceButton.title = isBookmarked ? 'Remove bookmark' : 'Add bookmark';
            }

            reorderLocationCards();
        }

        async function handleBookmarkClick(event) {
            event.preventDefault();
            event.stopPropagation();

            const button = event.currentTarget;
            const slug = button.dataset.slug;

            if (!slug) {
                return;
            }

            const wasBookmarked = button.dataset.bookmarked === 'true';
            const nextState = !wasBookmarked;

            updateBookmarkUI(slug, nextState, { sourceButton: button });

            try {
                const response = await fetch(`/campus/api/locations/${slug}/bookmark/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to toggle bookmark');
                }
            } catch (error) {
                console.error('Error toggling bookmark:', error);
                updateBookmarkUI(slug, wasBookmarked, { sourceButton: button });
            }
        }

        function attachBookmarkHandler(button) {
            if (!button || button.dataset.bookmarkAttached === 'true') {
                return;
            }

            button.addEventListener('click', handleBookmarkClick);
            button.dataset.bookmarkAttached = 'true';
        }

        function buildDetailMarkup(card) {
            const slug = card.dataset.slug || '';
            const name = card.dataset.displayName || '';
            const category = card.dataset.displayCategory || '';
            const address = card.dataset.displayAddress || '';
            const description = card.dataset.displayDescription || '';
            const image = card.dataset.image || '';
            const detailUrl = card.dataset.detailUrl || '#';
            const isBookmarked = card.dataset.bookmarked === 'true';
            const parts = [];

            parts.push(`<article class="location-detail-card" data-slug="${escapeHtml(slug)}">`);

            parts.push('<header class="location-detail-header">');
            parts.push(`<h3 class="location-detail-title">${escapeHtml(name)}</h3>`);
            if (category) {
                parts.push(`<span class="location-detail-category">${escapeHtml(category)}</span>`);
            }
            parts.push('</header>');

            if (address) {
                parts.push('<p class="location-detail-address">');
                parts.push('<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>');
                parts.push(`<span>${escapeHtml(address)}</span>`);
                parts.push('</p>');
            }

            if (image) {
                parts.push(`<img src="${escapeHtml(image)}" alt="${escapeHtml(name)}" class="location-detail-image" loading="lazy">`);
            } else {
                parts.push('<div class="location-detail-image placeholder" role="img" aria-label="No photo available for this location">');
                parts.push('<span>No photo available</span>');
                parts.push('</div>');
            }

            if (description) {
                parts.push(`<div class="location-detail-info-box">${formatText(description)}</div>`);
            }

            parts.push('<div class="location-detail-actions">');

            if (userIsAuthenticated) {
                const ariaLabel = `${isBookmarked ? 'Remove bookmark for ' : 'Bookmark '}${escapeHtml(name)}`;
                parts.push('<div class="location-detail-action-row">');
                parts.push(`<button type="button" class="bookmark-btn" data-slug="${escapeHtml(slug)}" data-name="${escapeHtml(name)}" data-bookmarked="${isBookmarked}" aria-label="${ariaLabel}" title="${isBookmarked ? 'Remove bookmark' : 'Add bookmark'}">`);
                parts.push(`<svg class="bookmark-icon${isBookmarked ? ' bookmarked' : ''}" width="20" height="20" viewBox="0 0 24 24" fill="${isBookmarked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>`);
                parts.push(`<span class="bookmark-label">${isBookmarked ? 'Bookmarked' : 'Bookmark'}</span>`);
                parts.push('</button>');
                parts.push(`<button type="button" class="location-detail-navigate-btn" data-slug="${escapeHtml(slug)}" aria-label="Navigate to ${escapeHtml(name)}" title="Navigate to ${escapeHtml(name)}">Navigate</button>`);
                parts.push('</div>');
            } else {
                parts.push(`<p class="location-detail-login">Please <a href="${escapeHtml(loginUrl)}">login</a> to bookmark this location.</p>`);
            }

            parts.push(`<a class="location-detail-full-link" href="${escapeHtml(detailUrl)}">View full page</a>`);
            parts.push('</div>');
            parts.push('</article>');

            return parts.join('');
        }

        function showLocationList() {
            if (locationListView) {
                locationListView.hidden = false;
                locationListView.setAttribute('aria-hidden', 'false');
            }
            if (locationDetailView) {
                locationDetailView.hidden = true;
                locationDetailView.dataset.activeSlug = '';
                locationDetailView.setAttribute('aria-hidden', 'true');
            }
            if (locationDetailContent) {
                locationDetailContent.innerHTML = '';
            }
            searchInput.disabled = false;
            searchInput.placeholder = 'Search locations...';
            applyFilter();

            if (lastFocusedSlug) {
                const targetCard = locationContainer.querySelector(`.location-card[data-slug="${lastFocusedSlug}"]`);
                targetCard?.focus();
            }
        }

        function showLocationDetail(card) {
            if (!locationDetailView || !locationDetailContent || !locationListView) {
                return;
            }

            const slug = card.dataset.slug || '';
            lastFocusedSlug = slug;
            locationDetailView.dataset.activeSlug = slug;
            locationDetailContent.innerHTML = buildDetailMarkup(card);
            locationListView.hidden = true;
            locationListView.setAttribute('aria-hidden', 'true');
            locationDetailView.hidden = false;
            locationDetailView.setAttribute('aria-hidden', 'false');
            locationDetailView.scrollTop = 0;
            searchInput.disabled = true;
            searchInput.placeholder = 'Search disabled while viewing details';

            const detailBookmarkButton = locationDetailContent.querySelector('.bookmark-btn');
            if (detailBookmarkButton) {
                attachBookmarkHandler(detailBookmarkButton);
            }

            const focusTarget = locationDetailContent.querySelector('.bookmark-btn') || locationDetailContent.querySelector('.location-detail-full-link');
            (focusTarget || locationDetailBack)?.focus();

            updateEmptyState(locationItems.length);
        }

        function attachCardInteractions(card) {
            card.addEventListener('click', (event) => {
                if (event.defaultPrevented) {
                    return;
                }
                if (event.target.closest('button') || event.target.closest('a')) {
                    return;
                }
                showLocationDetail(card);
            });

            card.addEventListener('keydown', (event) => {
                const key = event.key;
                if (key === 'Enter' || key === ' ' || key === 'Spacebar') {
                    if (event.target.closest('button') || event.target.closest('a')) {
                        return;
                    }
                    event.preventDefault();
                    showLocationDetail(card);
                }
            });
        }

        function toggleView() {
            const view = viewSelect.value;

            if (view === 'locations') {
                locationSection.hidden = false;
                toursSection.hidden = true;
                showLocationList();
            } else {
                locationSection.hidden = true;
                toursSection.hidden = false;
                searchInput.value = '';
                searchInput.disabled = true;
                searchInput.placeholder = 'Search disabled for tours';
                updateEmptyState(locationItems.length);
            }
        }

        locationItems.forEach((item) => {
            attachCardInteractions(item);
            const bookmarkButton = item.querySelector('.bookmark-btn');
            attachBookmarkHandler(bookmarkButton);
        });

        if (locationDetailBack) {
            locationDetailBack.addEventListener('click', () => {
                showLocationList();
                locationDetailBack.blur();
            });
        }

        viewSelect.addEventListener('change', toggleView);
        searchInput.addEventListener('input', applyFilter);

        toggleView();
    })();
</script>
<script>
    (function () {
        const storageKey = 'campusChatHistory';
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-message');
        const chatSubmit = document.getElementById('chat-submit');
        const chatHistoryEl = document.getElementById('chat-history');
        const chatEndpoint = "{% url 'campus:chat' %}";
        let typingEl = null;

        function persistHistory(history) {
            try {
                localStorage.setItem(storageKey, JSON.stringify(history));
            } catch (error) {
                console.warn('Unable to persist chat history', error);
            }
        }

        function loadHistory() {
            try {
                const raw = localStorage.getItem(storageKey);
                if (!raw) {
                    return [];
                }
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (error) {
                console.warn('Unable to load chat history', error);
                return [];
            }
        }

        function createMessageElement(entry) {
            const message = document.createElement('div');
            message.classList.add('chat-message', entry.role === 'assistant' ? 'assistant' : 'user');
            message.textContent = entry.content;
            return message;
        }

        function showTypingIndicator() {
            if (typingEl) {
                return;
            }
            typingEl = document.createElement('div');
            typingEl.className = 'chat-message assistant typing';
            const indicator = document.createElement('span');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = 'Thinking<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            typingEl.appendChild(indicator);
            chatHistoryEl.appendChild(typingEl);
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }

        function hideTypingIndicator() {
            if (!typingEl) {
                return;
            }
            typingEl.remove();
            typingEl = null;
        }

        function renderHistory(history) {
            chatHistoryEl.innerHTML = '';
            history.forEach((entry) => {
                chatHistoryEl.appendChild(createMessageElement(entry));
            });
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }

        async function sendMessage(event) {
            event.preventDefault();
            const content = chatInput.value.trim();
            if (!content) {
                return;
            }

            const history = loadHistory();
            const userEntry = { role: 'user', content };
            const updatedHistory = [...history, userEntry];

            renderHistory(updatedHistory);
            persistHistory(updatedHistory);

            showTypingIndicator();

            chatInput.value = '';
            chatInput.disabled = true;
            chatSubmit.disabled = true;
            chatSubmit.setAttribute('aria-disabled', 'true');

            try {
                const response = await fetch(chatEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: content,
                        history,
                    }),
                });

                const data = await response.json();
                hideTypingIndicator();
                const reply = data.reply || data.error || 'Sorry, something went wrong.';
                const assistantEntry = { role: 'assistant', content: reply };
                const finalHistory = [...updatedHistory, assistantEntry];
                renderHistory(finalHistory);
                persistHistory(finalHistory);
            } catch (error) {
                console.error('Chat failed', error);
                hideTypingIndicator();
                const assistantEntry = {
                    role: 'assistant',
                    content: 'I could not reach the campus assistant. Please try again shortly.',
                };
                const failedHistory = [...updatedHistory, assistantEntry];
                renderHistory(failedHistory);
                persistHistory(failedHistory);
            } finally {
                chatInput.disabled = false;
                chatSubmit.disabled = false;
                chatSubmit.setAttribute('aria-disabled', 'false');
                chatInput.focus();
            }
        }

        localStorage.removeItem(storageKey);

        chatForm.addEventListener('submit', sendMessage);
    })();
</script>
<script>
    // Tour functionality
    (function () {
        // Tour toggle buttons - use event delegation on document so it works even if elements are hidden
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('tour-toggle') || e.target.closest('.tour-toggle')) {
                const btn = e.target.classList.contains('tour-toggle') ? e.target : e.target.closest('.tour-toggle');
                const tourId = btn.dataset.tourId;
                if (tourId) {
                    const detailsEl = document.getElementById(`tour-details-${tourId}`);
                    if (detailsEl) {
                        const isHidden = detailsEl.hidden;
                        detailsEl.hidden = !isHidden;
                        btn.textContent = isHidden ? '▲' : '▼';
                    }
                    e.preventDefault();
                    e.stopPropagation();
                }
            }
        });

        // Tour functionality for maps
        let directionsService = null;
        let directionsRenderer = null;
        let currentTourRoute = null;
        let tourMarkers = [];

        function initTourFunctionality() {
            if (typeof google === 'undefined' || !google.maps) {
                return;
            }

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true, // We'll use custom numbered markers
                polylineOptions: {
                    strokeColor: '#0066cc',
                    strokeWeight: 4,
                    strokeOpacity: 0.8
                }
            });

            // View on map buttons
            document.querySelectorAll('.view-tour-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const tourId = parseInt(e.target.dataset.tourId);
                    await displayTourOnMap(tourId);
                });
            });

            // Add clear route button if tours are displayed
            const tourSection = document.getElementById('tour-list-section');
            if (tourSection && !document.getElementById('clear-route-btn')) {
                const clearBtn = document.createElement('button');
                clearBtn.id = 'clear-route-btn';
                clearBtn.className = 'clear-route-btn';
                clearBtn.textContent = 'Clear Route';
                clearBtn.style.display = 'none';
                clearBtn.addEventListener('click', clearTourRoute);
                const tourListHeader = tourSection.querySelector('.tour-list-header');
                if (tourListHeader) {
                    tourListHeader.appendChild(clearBtn);
                }
            }
        }

        async function displayTourOnMap(tourId) {
            if (!map || !directionsService || !directionsRenderer) {
                alert('Map is not ready. Please wait a moment and try again.');
                return;
            }

            try {
                const response = await fetch(`{% url 'campus:tour-list' %}`);
                const data = await response.json();
                const tour = data.tours.find(t => t.id === tourId);

                if (!tour || !tour.stops || tour.stops.length === 0) {
                    alert('Tour not found or has no stops.');
                    return;
                }

                // Clear previous route
                clearTourRoute();

                // Sort stops by order
                const sortedStops = tour.stops.sort((a, b) => a.order - b.order);

                if (sortedStops.length === 1) {
                    // Single stop - just show marker
                    const stop = sortedStops[0];
                    const position = {
                        lat: stop.location.latitude,
                        lng: stop.location.longitude
                    };
                    createNumberedMarker(position, 1, stop.location.name);
                    map.setCenter(position);
                    map.setZoom(18);
                    return;
                }

                // Multiple stops - create route
                const waypoints = sortedStops.slice(1, -1).map(stop => ({
                    location: {
                        lat: stop.location.latitude,
                        lng: stop.location.longitude
                    },
                    stopover: true
                }));

                const origin = {
                    lat: sortedStops[0].location.latitude,
                    lng: sortedStops[0].location.longitude
                };

                const destination = {
                    lat: sortedStops[sortedStops.length - 1].location.latitude,
                    lng: sortedStops[sortedStops.length - 1].location.longitude
                };

                directionsService.route({
                    origin: origin,
                    destination: destination,
                    waypoints: waypoints,
                    travelMode: google.maps.TravelMode.WALKING,
                    optimizeWaypoints: false
                }, (result, status) => {
                    if (status === 'OK') {
                        directionsRenderer.setDirections(result);
                        directionsRenderer.setMap(map);
                        currentTourRoute = tourId;

                        // Add numbered markers for each stop
                        sortedStops.forEach((stop, index) => {
                            const position = {
                                lat: stop.location.latitude,
                                lng: stop.location.longitude
                            };
                            createNumberedMarker(position, index + 1, stop.location.name);
                        });

                        // Show clear button
                        const clearBtn = document.getElementById('clear-route-btn');
                        if (clearBtn) {
                            clearBtn.style.display = 'block';
                        }
                    } else {
                        console.error('Directions request failed:', status);
                        alert('Unable to calculate route. Please try again.');
                    }
                });
            } catch (error) {
                console.error('Error fetching tour:', error);
                alert('Error loading tour. Please try again.');
            }
        }

        function createNumberedMarker(position, number, title) {
            const marker = new google.maps.Marker({
                position: position,
                map: map,
                title: title,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#003057',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2,
                    labelOrigin: new google.maps.Point(0, 0)
                },
                label: {
                    text: number.toString(),
                    color: '#ffffff',
                    fontSize: '12px',
                    fontWeight: 'bold'
                }
            });
            tourMarkers.push(marker);
        }

        function clearTourRoute() {
            if (directionsRenderer) {
                directionsRenderer.setDirections({ routes: [] });
                directionsRenderer.setMap(null);
            }
            
            // Remove all tour markers
            tourMarkers.forEach(marker => marker.setMap(null));
            tourMarkers = [];
            
            currentTourRoute = null;

            // Hide clear button
            const clearBtn = document.getElementById('clear-route-btn');
            if (clearBtn) {
                clearBtn.style.display = 'none';
            }
        }

        // Initialize tour functionality after map is loaded
        if (typeof window.initCampusMap !== 'undefined') {
            const originalInit = window.initCampusMap;
            window.initCampusMap = function() {
                originalInit();
                // Wait a bit for map to fully initialize
                setTimeout(initTourFunctionality, 500);
            };
        } else {
            // If map loads before this script, wait for it
            window.addEventListener('load', () => {
                setTimeout(initTourFunctionality, 1000);
            });
        }
    })();
</script>
{% if google_maps_api_key %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places&callback=initCampusMap" async defer></script>
{% endif %}
{% endblock %}
