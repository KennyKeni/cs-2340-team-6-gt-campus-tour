{% extends "base.html" %}

{% block title %}Campus Overview | GT Tour{% endblock %}

{% block content %}
<div class="campus-layout">
    <section class="panel side-panel" aria-labelledby="explore-heading">
        <header id="explore-heading" class="panel-heading">Explore Georgia Tech</header>
        <div class="sidebar-controls">
            <label class="visually-hidden" for="sidebar-view">Select view</label>
            <select id="sidebar-view" class="sidebar-select" aria-label="Choose content to display">
                <option value="locations" selected>Locations</option>
                <option value="tours">Tours</option>
            </select>
            <label class="visually-hidden" for="category-filter">Filter by category</label>
            <select id="category-filter" class="sidebar-select" aria-label="Filter locations by category">
                <option value="">All Categories</option>
                <option value="academic">Academic</option>
                <option value="athletics">Athletics</option>
                <option value="arts">Arts</option>
                <option value="historic">Historic</option>
                <option value="student life">Student Life</option>
                <option value="sustainability">Sustainability</option>
            </select>
            <div class="sidebar-search">
                <label class="visually-hidden" for="location-search">Search locations</label>
                <input id="location-search" type="search" placeholder="Search locations..." autocomplete="off">
            </div>
        </div>
        <div id="location-list-section" class="sidebar-content" aria-live="polite">
            <div id="location-list-view" class="location-list-view">
                <p class="sidebar-support-text">Browse campus highlights and tap markers on the map to learn more.</p>
                <div id="location-items" class="location-list">
                {% for location in locations %}
                <article class="location-card"
                    data-name="{{ location.name|lower }}"
                    data-category="{{ location.category|default_if_none:''|lower }}"
                    data-address="{{ location.address|default_if_none:''|lower }}"
                    data-description="{{ location.description|lower }}"
                    data-slug="{{ location.slug }}"
                    data-latitude="{{ location.latitude }}"
                    data-longitude="{{ location.longitude }}"
                    data-display-name="{{ location.name|escape }}"
                    data-display-category="{{ location.category|default:"Campus Highlight"|escape }}"
                    data-display-address="{{ location.address|default_if_none:''|escape }}"
                    data-display-description="{{ location.description|escape }}"
                    data-detail-url="{% url 'campus:location-detail' location.slug %}"
                    data-image="{% if location.photo %}{{ location.photo.url }}{% elif location.image_url %}{{ location.image_url }}{% endif %}"
                    data-bookmarked="{% if location.slug in bookmarked_slugs %}true{% else %}false{% endif %}"
                    role="button"
                    tabindex="0">
                    <div class="location-card-header">
                        <div>
                            <h3 class="location-title">{{ location.name }}</h3>
                            <p class="location-meta">{{ location.category|default:"Campus Highlight" }}</p>
                        </div>
                        {% if user.is_authenticated %}
                        <button class="bookmark-btn"
                                data-slug="{{ location.slug }}"
                                data-bookmarked="{% if location.slug in bookmarked_slugs %}true{% else %}false{% endif %}"
                                aria-label="Bookmark {{ location.name }}"
                                title="{% if location.slug in bookmarked_slugs %}Remove bookmark{% else %}Add bookmark{% endif %}">
                            <svg class="bookmark-icon {% if location.slug in bookmarked_slugs %}bookmarked{% endif %}"
                                 width="20" height="20" viewBox="0 0 24 24"
                                 fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                </article>
                {% endfor %}
                </div>
                <p id="location-empty" class="sidebar-empty" hidden>No locations match your search.</p>
            </div>
            <div id="location-detail-view" class="location-detail-view" hidden>
                <button type="button" id="location-detail-back" class="location-detail-back" aria-label="Back to locations">← Back to locations</button>
                <div id="location-detail-content" class="location-detail-content" aria-live="polite"></div>
            </div>
        </div>
        <div id="tour-list-section" class="sidebar-content" aria-live="polite" hidden>
            {% if user.is_authenticated %}
                <div class="tour-list-header">
                    <a href="{% url 'campus:tour-create' %}" class="create-tour-btn" id="tour-create-btn">+ Create Tour</a>
                </div>
                <div id="tour-list-view" class="tour-list-view">
                    <p class="sidebar-support-text">Select a tour to preview its stops and highlight the full route on the map.</p>
                    <div id="tour-items" class="tour-list">
                        {% for tour in tours %}
                        <article class="tour-card"
                                 data-tour-id="{{ tour.id }}"
                                 data-tour-name="{{ tour.name|escape }}"
                                 data-tour-description="{{ tour.description|default_if_none:''|escape }}"
                                 data-tour-stop-count="{{ tour.stops.count }}"
                                 data-tour-edit-url="{% url 'campus:tour-edit' tour.id %}"
                                 data-bookmarked="{% if tour.id in bookmarked_tour_ids %}true{% else %}false{% endif %}"
                                 role="button"
                                 tabindex="0">
                            <div class="tour-card-header">
                                <div>
                                    <h3 class="tour-title">{{ tour.name }}</h3>
                                    <p class="tour-stops-count">{{ tour.stops.count }} stop{{ tour.stops.count|pluralize }}</p>
                                </div>
                                <div class="tour-card-actions">
                                    <button class="tour-bookmark-btn sidebar-tour-bookmark"
                                            data-tour-id="{{ tour.id }}"
                                            data-bookmarked="{% if tour.id in bookmarked_tour_ids %}true{% else %}false{% endif %}"
                                            title="{% if tour.id in bookmarked_tour_ids %}Remove bookmark{% else %}Add bookmark{% endif %}"
                                            aria-label="Bookmark {{ tour.name }}">
                                        <svg class="bookmark-icon {% if tour.id in bookmarked_tour_ids %}bookmarked{% endif %}"
                                             width="20" height="20" viewBox="0 0 24 24"
                                             fill="{% if tour.id in bookmarked_tour_ids %}currentColor{% else %}none{% endif %}"
                                             stroke="currentColor" stroke-width="2">
                                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                                        </svg>
                                    </button>
                                    <span class="tour-card-indicator" aria-hidden="true">›</span>
                                </div>
                            </div>
                            {% if tour.description %}
                            <p class="tour-description-preview">{{ tour.description|truncatewords:22 }}</p>
                            {% endif %}
                        </article>
                        {% empty %}
                        <p class="sidebar-empty">No tours yet. <a href="{% url 'campus:tour-create' %}">Create your first tour</a>!</p>
                        {% endfor %}
                    </div>
                </div>
                <div id="tour-detail-view" class="location-detail-view" hidden>
                    <button type="button" id="tour-detail-back" class="location-detail-back" aria-label="Back to tours" hidden>← Back to tours</button>
                    <div id="tour-detail-content" class="location-detail-content" aria-live="polite"></div>
                </div>
            {% else %}
                <p class="sidebar-placeholder">Please <a href="{% url 'accounts:login' %}">login</a> to create and view tours.</p>
            {% endif %}
        </div>
    </section>
    <section class="panel map-panel" aria-labelledby="map-heading">
        <header id="map-heading" class="panel-heading">Campus Map</header>
        {% if not google_maps_api_key %}
        <div style="padding: 1rem; background: #fee2e2; border: 1px solid #fca5a5; border-radius: 4px; margin: 1rem;">
            <p style="margin: 0; color: #991b1b;"><strong>Map unavailable:</strong> Missing Google Maps API key. Please add <code>GOOGLE_MAP_API_KEY=your_key_here</code> to your .env file and restart the server.</p>
        </div>
        {% endif %}
        <div id="campus-map" class="map-canvas" role="application" aria-label="Georgia Tech campus map">
        </div>
    </section>
    <section class="panel chat-panel" aria-labelledby="chat-heading">
        <header id="chat-heading" class="panel-heading">Ask About Landmarks</header>
        {% if user.is_authenticated %}
        <div id="chat-history" class="chat-history" aria-live="polite">
        </div>
        <form id="chat-form" class="chat-input" novalidate>
            <label for="chat-message" class="visually-hidden">Ask a question about campus landmarks</label>
            <textarea id="chat-message" name="message" placeholder="Ask about a building or landmark..." required></textarea>
            <button type="submit" id="chat-submit">Send</button>
        </form>
        {% else %}
        <div class="chat-history">
            <p class="sidebar-placeholder">Please <a href="{% url 'accounts:login' %}">login</a> to use the AI chat assistant.</p>
        </div>
        {% endif %}
    </section>
</div>
{% endblock %}

{% block extra_body %}
{{ locations_payload|json_script:"initial-location-data" }}
{{ map_center|json_script:"map-center-data" }}
<script>
    const locationData = JSON.parse(document.getElementById('initial-location-data').textContent);
    const mapCenter = JSON.parse(document.getElementById('map-center-data').textContent);
    let map;

    function createInfoWindowContent(location) {
        const addressLine = location.address ? `<p><strong>Address:</strong> ${location.address}</p>` : '';
        const categoryLine = location.category ? `<p><strong>Category:</strong> ${location.category}</p>` : '';

        const photoUrl = location.photo || location.image_url;
        console.log('Photo URL for', location.name, ':', photoUrl);
        const photoLine = photoUrl ? `
            <div style="margin-bottom: 0.75rem;">
                <img src="${photoUrl}"
                     alt="${location.name}"
                     style="width: 100%; max-width: 300px; height: auto; border-radius: 8px; display: block; object-fit: cover;"
                     onerror="console.error('Failed to load image:', this.src); this.style.display='none';"
                     onload="console.log('Image loaded successfully:', this.src)">
            </div>
        ` : '';

        return `
            <div style="max-width: 320px;">
                ${photoLine}
                <h3 style="margin: 0 0 0.5rem; font-size: 1.1rem;">${location.name}</h3>
                ${categoryLine}
                ${addressLine}
                <p style="margin: 0.5rem 0;">${location.description}</p>
            </div>
        `;
    }

    window.initCampusMap = function initCampusMap() {
        const mapElement = document.getElementById('campus-map');
        if (!mapElement) {
            return;
        }
        const adjustedCenter = {
            lat: mapCenter.lat - 0.0015,
            lng: mapCenter.lng,
        };

        map = new google.maps.Map(mapElement, {
            center: adjustedCenter,
            zoom: 17,
            disableDefaultUI: false,
            zoomControl: true,
            streetViewControl: true,
            fullscreenControl: true,
            mapTypeControl: true,
            draggable: true,
            scrollwheel: true,
            disableDoubleClickZoom: false,
            keyboardShortcuts: true,
            gestureHandling: 'auto',
            styles: [
                { featureType: 'poi', elementType: 'labels.icon', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi', elementType: 'labels.text', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi', elementType: 'geometry', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi.business', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi.park', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi.school', stylers: [{ visibility: 'off' }] },
                { featureType: 'transit', stylers: [{ visibility: 'off' }] },
            ],
        });

        const infoWindow = new google.maps.InfoWindow();
        window.locationMarkers = [];

        locationData.forEach((location) => {
            const marker = new google.maps.Marker({
                position: { lat: location.latitude, lng: location.longitude },
                map,
                title: location.name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 7,
                    fillColor: '#fbbf24',
                    fillOpacity: 1,
                    strokeColor: '#003057',
                    strokeWeight: 2,
                },
            });

            window.locationMarkers.push({
                marker: marker,
                name: location.name,
                category: location.category,
                address: location.address,
                description: location.description,
            });

            marker.addListener('click', () => {
                infoWindow.setContent(createInfoWindowContent(location));
                infoWindow.open(map, marker);

                const locationCard = document.querySelector(`.location-card[data-slug="${location.slug}"]`);
                if (locationCard) {
                    const viewSelect = document.getElementById('sidebar-view');
                    if (viewSelect && viewSelect.value !== 'locations') {
                        viewSelect.value = 'locations';
                        viewSelect.dispatchEvent(new Event('change'));
                    }

                    locationCard.click();
                    locationCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    window.currentLocationCoords = currentLocation;

                    const currentLocationMarker = new google.maps.Marker({
                        position: currentLocation,
                        map,
                        title: 'Your Current Location',
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10,
                            fillColor: '#4285F4',
                            fillOpacity: 1,
                            strokeColor: '#ffffff',
                            strokeWeight: 3,
                        },
                        zIndex: 1000
                    });

                    const currentLocationInfoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 0.5rem;">
                                <h3 style="margin: 0 0 0.5rem; font-size: 1rem; color: #4285F4;">Your Current Location</h3>
                                <p style="margin: 0; font-size: 0.9rem;">Latitude: ${currentLocation.lat.toFixed(6)}</p>
                                <p style="margin: 0; font-size: 0.9rem;">Longitude: ${currentLocation.lng.toFixed(6)}</p>
                            </div>
                        `
                    });

                    currentLocationMarker.addListener('click', () => {
                        currentLocationInfoWindow.open(map, currentLocationMarker);
                    });
                },
                (error) => {
                    console.warn('Error getting current location:', error.message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        }

        if (!window.directionsService) {
            window.directionsService = new google.maps.DirectionsService();
        }
        if (!window.directionsRenderer) {
            window.directionsRenderer = new google.maps.DirectionsRenderer({
                map: map,
                suppressMarkers: false,
                polylineOptions: {
                    strokeColor: '#4285F4',
                    strokeWeight: 5,
                    strokeOpacity: 0.8
                }
            });
        }
    };
</script>
<script>
    (function () {
        const viewSelect = document.getElementById('sidebar-view');
        const searchInput = document.getElementById('location-search');
        const categoryFilter = document.getElementById('category-filter');
        const locationSection = document.getElementById('location-list-section');
        const toursSection = document.getElementById('tour-list-section');
        const locationListView = document.getElementById('location-list-view');
        const locationDetailView = document.getElementById('location-detail-view');
        const locationDetailContent = document.getElementById('location-detail-content');
        const locationDetailBack = document.getElementById('location-detail-back');
        const locationContainer = document.getElementById('location-items');
        const emptyState = document.getElementById('location-empty');
        const userIsAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
        const loginUrl = "{% url 'accounts:login' %}";
        const csrfToken = "{{ csrf_token }}";
        const locationItems = locationContainer ? Array.from(locationContainer.querySelectorAll('.location-card')) : [];
        let lastFocusedSlug = null;
        let currentLocationCoords = null;
        let directionsRenderer = null;
        let directionsService = null;

        if (!viewSelect || !searchInput || !locationSection || !toursSection || !locationContainer) {
            return;
        }

        const escapeHtml = (value = '') => String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

        const formatText = (value = '') => escapeHtml(value).replace(/\n/g, '<br>');

        function clearNavigationRoute() {
            if (window.directionsRenderer) {
                window.directionsRenderer.setDirections({ routes: [] });
            }
        }

        function updateEmptyState(visibleCount) {
            if (!emptyState) {
                return;
            }

            if (locationListView && locationListView.hidden) {
                emptyState.hidden = true;
                return;
            }

            emptyState.hidden = visibleCount > 0;
        }

        function applyFilter() {
            const query = searchInput.value.trim().toLowerCase();
            const selectedCategory = categoryFilter ? categoryFilter.value.toLowerCase() : '';
            let visibleCount = 0;

            locationItems.forEach((item) => {
                const haystack = [
                    item.dataset.name,
                    item.dataset.category,
                    item.dataset.address,
                    item.dataset.description,
                ].join(' ');

                const matchesSearch = !query || haystack.includes(query);
                const itemCategory = (item.dataset.category || '').toLowerCase();
                const matchesCategory = !selectedCategory || itemCategory === selectedCategory;
                const matches = matchesSearch && matchesCategory;

                item.hidden = !matches;
                if (matches) {
                    visibleCount += 1;
                }
            });

            updateEmptyState(visibleCount);
            updateMapMarkers(selectedCategory, searchInput.value.trim().toLowerCase());
        }

        function updateMapMarkers(selectedCategory, searchQuery) {
            if (!window.locationMarkers) {
                return;
            }

            window.locationMarkers.forEach((markerData) => {
                const category = (markerData.category || '').toLowerCase();
                const haystack = [
                    markerData.name || '',
                    markerData.category || '',
                    markerData.address || '',
                    markerData.description || '',
                ].join(' ').toLowerCase();

                const matchesSearch = !searchQuery || haystack.includes(searchQuery);
                const matchesCategory = !selectedCategory || category === selectedCategory;
                const isVisible = matchesSearch && matchesCategory;

                markerData.marker.setVisible(isVisible);
            });
        }

        function reorderLocationCards() {
            if (!locationContainer) {
                return;
            }

            const cards = Array.from(locationContainer.querySelectorAll('.location-card'));
            const bookmarkedCards = cards.filter((card) => card.dataset.bookmarked === 'true');
            const unbookmarkedCards = cards.filter((card) => card.dataset.bookmarked !== 'true');

            unbookmarkedCards.sort((a, b) => a.dataset.name.localeCompare(b.dataset.name));

            locationContainer.innerHTML = '';
            bookmarkedCards.forEach((card) => locationContainer.appendChild(card));
            unbookmarkedCards.forEach((card) => locationContainer.appendChild(card));

            const visibleCount = locationItems.reduce((count, item) => count + (item.hidden ? 0 : 1), 0);
            updateEmptyState(visibleCount);
        }

        function updateBookmarkUI(slug, isBookmarked, { sourceButton } = {}) {
            const bookmarkValue = isBookmarked ? 'true' : 'false';
            const card = locationContainer.querySelector(`.location-card[data-slug="${slug}"]`);
            const cardName = card?.dataset.displayName || '';

            if (card) {
                card.dataset.bookmarked = bookmarkValue;
                const cardButton = card.querySelector('.bookmark-btn');
                if (cardButton) {
                    cardButton.dataset.bookmarked = bookmarkValue;
                    cardButton.title = isBookmarked ? 'Remove bookmark' : 'Add bookmark';
                    cardButton.setAttribute('aria-label', `${isBookmarked ? 'Remove bookmark for ' : 'Bookmark '}${cardName}`);
                    const cardIcon = cardButton.querySelector('.bookmark-icon');
                    if (cardIcon) {
                        cardIcon.classList.toggle('bookmarked', isBookmarked);
                    }
                }

                if (isBookmarked && locationContainer.firstChild !== card) {
                    locationContainer.insertBefore(card, locationContainer.firstChild);
                }
            }

            const detailButton = locationDetailContent.querySelector(`.bookmark-btn[data-slug="${slug}"]`);
            if (detailButton) {
                detailButton.dataset.bookmarked = bookmarkValue;
                detailButton.title = isBookmarked ? 'Remove bookmark' : 'Add bookmark';
                const detailIcon = detailButton.querySelector('.bookmark-icon');
                if (detailIcon) {
                    detailIcon.classList.toggle('bookmarked', isBookmarked);
                    detailIcon.setAttribute('fill', isBookmarked ? 'currentColor' : 'none');
                }
                const label = detailButton.querySelector('.bookmark-label');
                if (label) {
                    label.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
                }
                const detailName = cardName || detailButton.dataset.name || '';
                detailButton.setAttribute('aria-label', `${isBookmarked ? 'Remove bookmark for ' : 'Bookmark '}${detailName}`);
            }

            if (sourceButton && sourceButton !== detailButton && (!card || sourceButton !== card.querySelector('.bookmark-btn'))) {
                const icon = sourceButton.querySelector('.bookmark-icon');
                if (icon) {
                    icon.classList.toggle('bookmarked', isBookmarked);
                    icon.setAttribute('fill', isBookmarked ? 'currentColor' : 'none');
                }
                const label = sourceButton.querySelector('.bookmark-label');
                if (label) {
                    label.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
                }
                sourceButton.dataset.bookmarked = bookmarkValue;
                sourceButton.title = isBookmarked ? 'Remove bookmark' : 'Add bookmark';
            }

            reorderLocationCards();
        }

        async function handleBookmarkClick(event) {
            event.preventDefault();
            event.stopPropagation();

            const button = event.currentTarget;
            const slug = button.dataset.slug;

            if (!slug) {
                return;
            }

            const wasBookmarked = button.dataset.bookmarked === 'true';
            const nextState = !wasBookmarked;

            updateBookmarkUI(slug, nextState, { sourceButton: button });

            try {
                const response = await fetch(`/campus/api/locations/${slug}/bookmark/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to toggle bookmark');
                }
            } catch (error) {
                console.error('Error toggling bookmark:', error);
                updateBookmarkUI(slug, wasBookmarked, { sourceButton: button });
            }
        }

        function attachBookmarkHandler(button) {
            if (!button || button.dataset.bookmarkAttached === 'true') {
                return;
            }

            button.addEventListener('click', handleBookmarkClick);
            button.dataset.bookmarkAttached = 'true';
        }

        function buildDetailMarkup(card) {
            const slug = card.dataset.slug || '';
            const name = card.dataset.displayName || '';
            const category = card.dataset.displayCategory || '';
            const address = card.dataset.displayAddress || '';
            const description = card.dataset.displayDescription || '';
            const image = card.dataset.image || '';
            const detailUrl = card.dataset.detailUrl || '#';
            const isBookmarked = card.dataset.bookmarked === 'true';
            const parts = [];

            parts.push(`<article class="location-detail-card" data-slug="${escapeHtml(slug)}">`);

            parts.push('<header class="location-detail-header">');
            parts.push(`<h3 class="location-detail-title">${escapeHtml(name)}</h3>`);
            if (category) {
                parts.push(`<span class="location-detail-category">${escapeHtml(category)}</span>`);
            }
            parts.push('</header>');

            if (address) {
                parts.push('<p class="location-detail-address">');
                parts.push('<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>');
                parts.push(`<span>${escapeHtml(address)}</span>`);
                parts.push('</p>');
            }

            if (image) {
                parts.push(`<img src="${escapeHtml(image)}" alt="${escapeHtml(name)}" class="location-detail-image" loading="lazy">`);
            } else {
                parts.push('<div class="location-detail-image placeholder" role="img" aria-label="No photo available for this location">');
                parts.push('<span>No photo available</span>');
                parts.push('</div>');
            }

            if (description) {
                parts.push(`<div class="location-detail-info-box">${formatText(description)}</div>`);
            }

            parts.push('<div class="location-detail-actions">');

            if (userIsAuthenticated) {
                const ariaLabel = `${isBookmarked ? 'Remove bookmark for ' : 'Bookmark '}${escapeHtml(name)}`;
                parts.push('<div class="location-detail-action-row">');
                parts.push(`<button type="button" class="bookmark-btn" data-slug="${escapeHtml(slug)}" data-name="${escapeHtml(name)}" data-bookmarked="${isBookmarked}" aria-label="${ariaLabel}" title="${isBookmarked ? 'Remove bookmark' : 'Add bookmark'}">`);
                parts.push(`<svg class="bookmark-icon${isBookmarked ? ' bookmarked' : ''}" width="20" height="20" viewBox="0 0 24 24" fill="${isBookmarked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>`);
                parts.push(`<span class="bookmark-label">${isBookmarked ? 'Bookmarked' : 'Bookmark'}</span>`);
                parts.push('</button>');
                parts.push(`<button type="button" class="location-detail-navigate-btn" data-slug="${escapeHtml(slug)}" aria-label="Navigate to ${escapeHtml(name)}" title="Navigate to ${escapeHtml(name)}">Navigate</button>`);
                parts.push('</div>');
            } else {
                parts.push(`<p class="location-detail-login">Please <a href="${escapeHtml(loginUrl)}">login</a> to bookmark this location.</p>`);
            }

            parts.push(`<a class="location-detail-full-link" href="${escapeHtml(detailUrl)}">View full page</a>`);
            parts.push('</div>');
            parts.push('</article>');

            return parts.join('');
        }

        function showLocationList() {
            if (locationListView) {
                locationListView.hidden = false;
                locationListView.setAttribute('aria-hidden', 'false');
            }
            if (locationDetailView) {
                locationDetailView.hidden = true;
                locationDetailView.dataset.activeSlug = '';
                locationDetailView.setAttribute('aria-hidden', 'true');
            }
            if (locationDetailContent) {
                locationDetailContent.innerHTML = '';
            }
            searchInput.disabled = false;
            searchInput.placeholder = 'Search locations...';
            applyFilter();
            clearNavigationRoute();

            if (lastFocusedSlug) {
                const targetCard = locationContainer.querySelector(`.location-card[data-slug="${lastFocusedSlug}"]`);
                targetCard?.focus();
            }
        }

        function showLocationDetail(card) {
            if (!locationDetailView || !locationDetailContent || !locationListView) {
                return;
            }

            const slug = card.dataset.slug || '';
            lastFocusedSlug = slug;
            locationDetailView.dataset.activeSlug = slug;
            locationDetailContent.innerHTML = buildDetailMarkup(card);
            locationListView.hidden = true;
            locationListView.setAttribute('aria-hidden', 'true');
            locationDetailView.hidden = false;
            locationDetailView.setAttribute('aria-hidden', 'false');
            locationDetailView.scrollTop = 0;
            searchInput.disabled = true;
            searchInput.placeholder = 'Search disabled while viewing details';

            const detailBookmarkButton = locationDetailContent.querySelector('.bookmark-btn');
            if (detailBookmarkButton) {
                attachBookmarkHandler(detailBookmarkButton);
            }

            const navigateButton = locationDetailContent.querySelector('.location-detail-navigate-btn');
            if (navigateButton) {
                attachNavigateHandler(navigateButton, card);
            }

            const focusTarget = locationDetailContent.querySelector('.bookmark-btn') || locationDetailContent.querySelector('.location-detail-full-link');
            (focusTarget || locationDetailBack)?.focus();

            updateEmptyState(locationItems.length);
        }

        function attachNavigateHandler(button, card) {
            if (!button || button.dataset.navigateAttached === 'true') {
                return;
            }

            button.addEventListener('click', (event) => {
                event.preventDefault();
                event.stopPropagation();
                navigateToLocation(card);
            });
            button.dataset.navigateAttached = 'true';
        }

        function navigateToLocation(card) {
            if (!window.currentLocationCoords) {
                alert('Current location not available. Please enable location services and refresh the page.');
                return;
            }

            if (!map || !window.directionsService || !window.directionsRenderer) {
                alert('Map services not ready. Please try again in a moment.');
                return;
            }

            const lat = parseFloat(card.dataset.latitude);
            const lng = parseFloat(card.dataset.longitude);

            if (isNaN(lat) || isNaN(lng)) {
                alert('Invalid location coordinates.');
                return;
            }

            const destination = { lat, lng };

            const request = {
                origin: window.currentLocationCoords,
                destination: destination,
                travelMode: google.maps.TravelMode.WALKING
            };

            window.directionsService.route(request, (result, status) => {
                if (status === google.maps.DirectionsStatus.OK) {
                    window.directionsRenderer.setDirections(result);
                } else {
                    console.error('Could not calculate route:', status);
                }
            });
        }

        function attachCardInteractions(card) {
            card.addEventListener('click', (event) => {
                if (event.defaultPrevented) {
                    return;
                }
                if (event.target.closest('button') || event.target.closest('a')) {
                    return;
                }
                showLocationDetail(card);
            });

            card.addEventListener('keydown', (event) => {
                const key = event.key;
                if (key === 'Enter' || key === ' ' || key === 'Spacebar') {
                    if (event.target.closest('button') || event.target.closest('a')) {
                        return;
                    }
                    event.preventDefault();
                    showLocationDetail(card);
                }
            });
        }

        function toggleView() {
            const view = viewSelect.value;

            if (view === 'locations') {
                locationSection.hidden = false;
                toursSection.hidden = true;
                window.campusTours?.showTourList?.({ restoreFocus: false, clearRoute: true });
                showLocationList();
                if (categoryFilter) {
                    categoryFilter.disabled = false;
                }
            } else {
                locationSection.hidden = true;
                toursSection.hidden = false;
                window.campusTours?.showTourList?.({ restoreFocus: false });
                searchInput.value = '';
                searchInput.disabled = true;
                searchInput.placeholder = 'Search disabled for tours';
                if (categoryFilter) {
                    categoryFilter.disabled = true;
                    categoryFilter.value = '';
                }
                updateEmptyState(locationItems.length);
            }
        }

        locationItems.forEach((item) => {
            attachCardInteractions(item);
            const bookmarkButton = item.querySelector('.bookmark-btn');
            attachBookmarkHandler(bookmarkButton);
        });

        if (locationDetailBack) {
            locationDetailBack.addEventListener('click', () => {
                showLocationList();
                locationDetailBack.blur();
            });
        }

        viewSelect.addEventListener('change', toggleView);
        searchInput.addEventListener('input', applyFilter);
        if (categoryFilter) {
            categoryFilter.addEventListener('change', applyFilter);
        }

        toggleView();

        const urlParams = new URLSearchParams(window.location.search);
        const navigateSlug = urlParams.get('navigate');
        const tourId = urlParams.get('tour');

        // Handle tour URL parameter
        if (tourId) {
            // Switch to tours view in the sidebar
            const viewSelect = document.getElementById('sidebar-view');
            if (viewSelect) {
                viewSelect.value = 'tours';
                // Trigger the change event to update the UI
                viewSelect.dispatchEvent(new Event('change'));
            }

            // Wait a bit for the tours to load, then show the tour
            setTimeout(() => {
                const tourCard = document.querySelector(`.tour-card[data-tour-id="${tourId}"]`);
                if (tourCard) {
                    tourCard.click();
                }
            }, 300);
        }

        if (navigateSlug) {
            const targetCard = locationContainer.querySelector(`.location-card[data-slug="${navigateSlug}"]`);
            if (targetCard) {
                function waitForCurrentLocation(callback, maxAttempts = 20, attemptCount = 0) {
                    if (window.currentLocationCoords) {
                        callback();
                    } else if (attemptCount < maxAttempts) {
                        setTimeout(() => waitForCurrentLocation(callback, maxAttempts, attemptCount + 1), 250);
                    } else {
                        showLocationDetail(targetCard);
                        alert('Current location not available. Please enable location services to get directions.');
                    }
                }

                waitForCurrentLocation(() => {
                    showLocationDetail(targetCard);
                    const navigateButton = locationDetailContent.querySelector('.location-detail-navigate-btn');
                    if (navigateButton) {
                        navigateButton.click();
                    }
                });
            }
        }
    })();
</script>
<script>
    (function () {
        const userIsAuthenticated = {{ user.is_authenticated|yesno:"true,false" }};
        if (!userIsAuthenticated) {
            return;
        }

        const storageKey = 'campusChatHistory';
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-message');
        const chatSubmit = document.getElementById('chat-submit');
        const chatHistoryEl = document.getElementById('chat-history');
        const chatEndpoint = "{% url 'campus:chat' %}";
        let typingEl = null;

        function persistHistory(history) {
            try {
                localStorage.setItem(storageKey, JSON.stringify(history));
            } catch (error) {
                console.warn('Unable to persist chat history', error);
            }
        }

        function loadHistory() {
            try {
                const raw = localStorage.getItem(storageKey);
                if (!raw) {
                    return [];
                }
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (error) {
                console.warn('Unable to load chat history', error);
                return [];
            }
        }

        function formatChatContent(text) {
            let formatted = text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;');
            formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\n/g, '<br>');
            return formatted;
        }

        function createMessageElement(entry) {
            const message = document.createElement('div');
            message.classList.add('chat-message', entry.role === 'assistant' ? 'assistant' : 'user');
            if (entry.role === 'assistant') {
                message.innerHTML = formatChatContent(entry.content);
            } else {
                message.textContent = entry.content;
            }
            return message;
        }

        function showTypingIndicator() {
            if (typingEl) {
                return;
            }
            typingEl = document.createElement('div');
            typingEl.className = 'chat-message assistant typing';
            const indicator = document.createElement('span');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = 'Thinking<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            typingEl.appendChild(indicator);
            chatHistoryEl.appendChild(typingEl);
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }

        function hideTypingIndicator() {
            if (!typingEl) {
                return;
            }
            typingEl.remove();
            typingEl = null;
        }

        function renderHistory(history) {
            chatHistoryEl.innerHTML = '';
            history.forEach((entry) => {
                chatHistoryEl.appendChild(createMessageElement(entry));
            });
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }

        async function sendMessage(event) {
            event.preventDefault();
            const content = chatInput.value.trim();
            if (!content) {
                return;
            }

            const history = loadHistory();
            const userEntry = { role: 'user', content };
            const updatedHistory = [...history, userEntry];

            renderHistory(updatedHistory);
            persistHistory(updatedHistory);

            showTypingIndicator();

            chatInput.value = '';
            chatInput.disabled = true;
            chatSubmit.disabled = true;
            chatSubmit.setAttribute('aria-disabled', 'true');

            try {
                const response = await fetch(chatEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: content,
                        history,
                    }),
                });

                const data = await response.json();
                hideTypingIndicator();
                const reply = data.reply || data.error || 'Sorry, something went wrong.';
                const assistantEntry = { role: 'assistant', content: reply };
                const finalHistory = [...updatedHistory, assistantEntry];
                renderHistory(finalHistory);
                persistHistory(finalHistory);

                if (data.created_tour_id && window.campusTours) {
                    const viewSelect = document.getElementById('sidebar-view');
                    if (viewSelect) {
                        viewSelect.value = 'tours';
                        viewSelect.dispatchEvent(new Event('change'));
                    }
                    setTimeout(async () => {
                        await window.campusTours.addTourCard(data.created_tour_id);
                        window.campusTours.showTourDetail(data.created_tour_id);
                    }, 300);
                }
            } catch (error) {
                console.error('Chat failed', error);
                hideTypingIndicator();
                const assistantEntry = {
                    role: 'assistant',
                    content: 'I could not reach the campus assistant. Please try again shortly.',
                };
                const failedHistory = [...updatedHistory, assistantEntry];
                renderHistory(failedHistory);
                persistHistory(failedHistory);
            } finally {
                chatInput.disabled = false;
                chatSubmit.disabled = false;
                chatSubmit.setAttribute('aria-disabled', 'false');
                chatInput.focus();
            }
        }

        localStorage.removeItem(storageKey);

        chatForm.addEventListener('submit', sendMessage);
    })();
</script>
<script>
    // Tour functionality
    (function () {
        const tourSection = document.getElementById('tour-list-section');
        const tourListView = document.getElementById('tour-list-view');
        const tourDetailView = document.getElementById('tour-detail-view');
        const tourDetailContent = document.getElementById('tour-detail-content');
        const tourDetailBack = document.getElementById('tour-detail-back');
        const tourContainer = document.getElementById('tour-items');
        const tourCreateBtn = document.getElementById('tour-create-btn');
        const tourListHeader = tourCreateBtn ? tourCreateBtn.closest('.tour-list-header') : null;
        const csrfToken = "{{ csrf_token }}";

        const noop = () => {};

        if (!tourSection || !tourContainer) {
            window.campusTours = {
                showTourList: noop,
                clearTourRoute: noop,
                displayTourOnMap: async () => null,
            };
            return;
        }

        let currentTourData = null;
        let currentSegmentIndex = 0;
        let segmentPolylines = [];
        let tourMarkers = [];
        let tourCache = null;
        let lastFocusedTourCard = null;
        let currentTourCard = null;
        let showingAllSegments = true;

        let navControls = null;
        let prevBtn = null;
        let nextBtn = null;
        let showAllBtn = null;
        let segmentIndicator = null;

        const escapeHtml = (value = '') => String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');

        const formatText = (value = '') => escapeHtml(value).replace(/\n/g, '<br>');

        function setNavControlsVisibility(show) {
            if (show) {
                ensureNavControls();
            }
            if (navControls) {
                navControls.style.display = show ? 'flex' : 'none';
            }
        }

        function updateSegmentIndicator() {
            if (!segmentIndicator) {
                return;
            }

            if (!currentTourData) {
                segmentIndicator.textContent = 'Select a tour to preview its route';
                if (prevBtn) prevBtn.disabled = true;
                if (nextBtn) nextBtn.disabled = true;
                if (showAllBtn) {
                    showAllBtn.disabled = true;
                    showAllBtn.textContent = 'Show entire route';
                }
                return;
            }

            const segments = Array.isArray(currentTourData.route_data?.segments) ? currentTourData.route_data.segments : [];
            if (!segments.length) {
                segmentIndicator.textContent = 'Route preview unavailable';
                if (prevBtn) prevBtn.disabled = true;
                if (nextBtn) nextBtn.disabled = true;
                if (showAllBtn) {
                    showAllBtn.disabled = true;
                    showAllBtn.textContent = 'Show entire route';
                }
                return;
            }

            const totalSegments = segments.length;

            if (showingAllSegments) {
                segmentIndicator.textContent = `Full route visible (${totalSegments} segment${totalSegments === 1 ? '' : 's'})`;
                if (prevBtn) prevBtn.disabled = totalSegments <= 1;
                if (nextBtn) nextBtn.disabled = totalSegments <= 1;
            } else {
                segmentIndicator.textContent = `Segment ${currentSegmentIndex + 1} of ${totalSegments}`;
                if (prevBtn) prevBtn.disabled = currentSegmentIndex === 0;
                if (nextBtn) nextBtn.disabled = currentSegmentIndex >= totalSegments - 1;
            }

            if (showAllBtn) {
                showAllBtn.disabled = showingAllSegments;
                showAllBtn.textContent = showingAllSegments ? 'Full route visible' : 'Show entire route';
            }
        }

        function clearTourRoute() {
            segmentPolylines.forEach((polyline) => polyline.setMap(null));
            segmentPolylines = [];

            tourMarkers.forEach((marker) => marker.setMap(null));
            tourMarkers = [];

            currentTourData = null;
            currentSegmentIndex = 0;
            showingAllSegments = true;

            setNavControlsVisibility(false);
            updateSegmentIndicator();
        }

        function fitMapToTour(stops) {
            if (!map || !Array.isArray(stops) || stops.length === 0) {
                return;
            }

            const bounds = new google.maps.LatLngBounds();
            stops.forEach((stop) => {
                if (stop.location) {
                    bounds.extend(new google.maps.LatLng(stop.location.latitude, stop.location.longitude));
                }
            });
            map.fitBounds(bounds);
        }

        function showAllSegments({ fitBounds = false } = {}) {
            if (!segmentPolylines.length) {
                return;
            }

            segmentPolylines.forEach((polyline) => {
                polyline.setOptions({
                    strokeOpacity: 0.75,
                    strokeWeight: 4,
                    map,
                });
            });

            showingAllSegments = true;
            updateSegmentIndicator();

            if (fitBounds && currentTourData) {
                fitMapToTour(currentTourData.stops || []);
            }
        }

        function showSegment(index) {
            if (!currentTourData || !currentTourData.route_data) {
                return;
            }

            const segments = currentTourData.route_data.segments;
            if (!Array.isArray(segments) || !segments.length) {
                return;
            }

            const clampedIndex = Math.max(0, Math.min(index, segments.length - 1));

            segmentPolylines.forEach((polyline, idx) => {
                if (idx === clampedIndex) {
                    polyline.setOptions({
                        strokeOpacity: 0.95,
                        strokeWeight: 5,
                        map,
                    });
                } else {
                    polyline.setOptions({
                        strokeOpacity: 0.25,
                        strokeWeight: 3,
                        map,
                    });
                }
            });

            showingAllSegments = false;
            currentSegmentIndex = clampedIndex;
            updateSegmentIndicator();

            const segment = segments[clampedIndex];
            if (segment) {
                const bounds = new google.maps.LatLngBounds();
                bounds.extend(new google.maps.LatLng(segment.origin.lat, segment.origin.lng));
                bounds.extend(new google.maps.LatLng(segment.destination.lat, segment.destination.lng));
                map.fitBounds(bounds);
                map.setZoom(Math.min(map.getZoom(), 17));
            }
        }

        function showPreviousSegment() {
            if (!currentTourData || !currentTourData.route_data || !Array.isArray(currentTourData.route_data.segments) || !currentTourData.route_data.segments.length) {
                return;
            }

            if (showingAllSegments) {
                showSegment(currentTourData.route_data.segments.length - 1);
            } else if (currentSegmentIndex > 0) {
                showSegment(currentSegmentIndex - 1);
            }
        }

        function showNextSegment() {
            if (!currentTourData || !currentTourData.route_data || !Array.isArray(currentTourData.route_data.segments) || !currentTourData.route_data.segments.length) {
                return;
            }

            if (showingAllSegments) {
                showSegment(0);
            } else if (currentSegmentIndex < currentTourData.route_data.segments.length - 1) {
                showSegment(currentSegmentIndex + 1);
            }
        }

        function ensureNavControls() {
            if (navControls) {
                return;
            }

            navControls = document.createElement('div');
            navControls.id = 'tour-nav-controls';
            navControls.className = 'tour-nav-controls';
            navControls.style.display = 'none';
            navControls.innerHTML = `
                <div class="tour-nav-indicator-row">
                    <span id="segment-indicator" class="tour-nav-indicator" aria-live="polite">Showing full tour</span>
                </div>
                <div class="tour-nav-action-row">
                    <button id="show-all-btn" type="button" class="tour-nav-chip">Show entire route</button>
                </div>
                <div class="tour-nav-row">
                    <button id="prev-segment-btn" type="button" class="tour-nav-btn" aria-label="Show previous segment">
                        <span class="tour-nav-icon" aria-hidden="true">←</span>
                        <span class="tour-nav-label">Previous segment</span>
                    </button>
                    <button id="next-segment-btn" type="button" class="tour-nav-btn" aria-label="Show next segment">
                        <span class="tour-nav-label">Next segment</span>
                        <span class="tour-nav-icon" aria-hidden="true">→</span>
                    </button>
                </div>
            `;

            if (tourDetailBack) {
                tourDetailBack.insertAdjacentElement('afterend', navControls);
            } else if (tourDetailView) {
                tourDetailView.insertBefore(navControls, tourDetailContent);
            } else {
                tourSection.appendChild(navControls);
            }

            prevBtn = navControls.querySelector('#prev-segment-btn');
            nextBtn = navControls.querySelector('#next-segment-btn');
            showAllBtn = navControls.querySelector('#show-all-btn');
            segmentIndicator = navControls.querySelector('#segment-indicator');

            prevBtn?.addEventListener('click', showPreviousSegment);
            nextBtn?.addEventListener('click', showNextSegment);
            showAllBtn?.addEventListener('click', () => showAllSegments({ fitBounds: true }));

            updateSegmentIndicator();
        }

        function createNumberedMarker(position, number, title) {
            const marker = new google.maps.Marker({
                position,
                map,
                title,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 12,
                    fillColor: '#003057',
                    fillOpacity: 1,
                    strokeColor: '#ffffff',
                    strokeWeight: 2,
                    labelOrigin: new google.maps.Point(0, 0),
                },
                label: {
                    text: number.toString(),
                    color: '#ffffff',
                    fontSize: '12px',
                    fontWeight: 'bold',
                },
            });

            tourMarkers.push(marker);
            return marker;
        }

        async function fetchTours(forceRefresh = false) {
            if (tourCache && !forceRefresh) {
                return tourCache;
            }

            const response = await fetch(`{% url 'campus:tour-list' %}`);
            if (!response.ok) {
                throw new Error('Failed to fetch tours');
            }

            const data = await response.json();
            tourCache = Array.isArray(data.tours) ? data.tours : [];
            return tourCache;
        }

        async function getTourById(tourId) {
            const tours = await fetchTours();
            return tours.find((tour) => tour.id === tourId);
        }

        function createTourCardElement(tour) {
            const card = document.createElement('article');
            card.className = 'tour-card';
            card.dataset.tourId = tour.id;
            card.dataset.tourName = tour.name || '';
            card.dataset.tourDescription = tour.description || '';
            card.dataset.tourStopCount = tour.stops ? tour.stops.length : 0;
            card.dataset.tourEditUrl = `{% url 'campus:tour-edit' 0 %}`.replace('0', tour.id);
            card.dataset.bookmarked = 'false';
            card.setAttribute('role', 'button');
            card.setAttribute('tabindex', '0');

            const stopCount = tour.stops ? tour.stops.length : 0;
            const stopText = stopCount === 1 ? '1 stop' : `${stopCount} stops`;

            card.innerHTML = `
                <div class="tour-card-header">
                    <div>
                        <h3 class="tour-title">${escapeHtml(tour.name || 'Untitled')}</h3>
                        <p class="tour-stops-count">${stopText}</p>
                    </div>
                    <div class="tour-card-actions">
                        <button class="tour-bookmark-btn sidebar-tour-bookmark"
                                data-tour-id="${tour.id}"
                                data-bookmarked="false"
                                title="Add bookmark">
                            <svg class="bookmark-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z"/>
                            </svg>
                        </button>
                        <span class="tour-card-indicator" aria-hidden="true">›</span>
                    </div>
                </div>
                ${tour.description ? `<p class="tour-description-preview">${escapeHtml(tour.description.split(' ').slice(0, 22).join(' '))}${tour.description.split(' ').length > 22 ? '...' : ''}</p>` : ''}
            `;

            return card;
        }

        async function refreshTourList() {
            tourCache = null;
            await fetchTours(true);
        }

        async function addTourCard(tourId) {
            await refreshTourList();
            const tour = await getTourById(tourId);
            if (!tour) return null;

            const card = createTourCardElement(tour);
            tourContainer.insertBefore(card, tourContainer.firstChild);
            attachCardHandlers();
            return card;
        }

        function showTourList({ restoreFocus = true, clearRoute = false } = {}) {
            if (clearRoute) {
                clearTourRoute();
            }

            if (tourCreateBtn) {
                tourCreateBtn.hidden = false;
                tourCreateBtn.setAttribute('aria-hidden', 'false');
                tourCreateBtn.style.display = '';
            }

            if (tourDetailBack) {
                tourDetailBack.hidden = true;
                tourDetailBack.setAttribute('aria-hidden', 'true');
            }

            setNavControlsVisibility(false);

            if (tourListView) {
                tourListView.hidden = false;
                tourListView.setAttribute('aria-hidden', 'false');
                tourListView.style.display = '';
            }

            if (tourListHeader) {
                tourListHeader.style.display = '';
            }

            if (tourDetailView) {
                tourDetailView.hidden = true;
                tourDetailView.setAttribute('aria-hidden', 'true');
                tourDetailView.dataset.activeTourId = '';
                tourDetailView.style.display = 'none';
            }

            if (tourSection) {
                tourSection.classList.remove('detail-view-active');
            }

            if (tourDetailContent) {
                tourDetailContent.innerHTML = '';
            }

            currentTourCard = null;

            if (restoreFocus && lastFocusedTourCard) {
                lastFocusedTourCard.focus();
            }
        }

        function renderTourDetail(tour) {
            if (!tourDetailContent) {
                return;
            }

            const stops = Array.isArray(tour.stops) ? [...tour.stops].sort((a, b) => a.order - b.order) : [];
            const stopCount = stops.length;
            const editUrl = currentTourCard?.dataset.tourEditUrl || '';
            const parts = [];

            const segments = tour.route_data?.segments || [];
            let totalDurationText = '';
            if (segments.length > 0) {
                let totalMinutes = 0;
                segments.forEach(seg => {
                    const match = seg.duration?.match(/(\d+)/);
                    if (match) totalMinutes += parseInt(match[1], 10);
                });
                if (totalMinutes > 0) {
                    totalDurationText = ` | Est. ${totalMinutes} min walk`;
                }
            }

            const isBookmarked = tour.is_bookmarked || false;
            parts.push(`<article class="location-detail-card" data-tour-id="${tour.id}">`);
            parts.push('<header class="location-detail-header">');
            parts.push(`<h3 class="location-detail-title">${escapeHtml(tour.name || 'Untitled tour')}</h3>`);
            parts.push('<span class="location-detail-category">Custom Tour</span>');
            parts.push('</header>');
            parts.push(`<p class="tour-detail-meta">${stopCount} stop${stopCount === 1 ? '' : 's'}${totalDurationText}</p>`);

            if (tour.description) {
                parts.push(`<div class="location-detail-info-box">${formatText(tour.description)}</div>`);
            }

            parts.push('<div class="tour-detail-stops">');
            parts.push('<h4 class="tour-detail-heading">Tour Stops</h4>');

            if (stopCount) {
                parts.push('<ol class="tour-stop-cards">');
                stops.forEach((stop, index) => {
                    const name = stop.location?.name ? escapeHtml(stop.location.name) : 'Unknown location';
                    const category = stop.location?.category ? escapeHtml(stop.location.category) : '';
                    const address = stop.location?.address ? escapeHtml(stop.location.address) : '';
                    parts.push('<li class="tour-stop-card">');
                    parts.push(`<span class="tour-stop-index" aria-hidden="true">${index + 1}</span>`);
                    parts.push('<div class="tour-stop-content">');
                    parts.push('<div class="tour-stop-title-row">');
                    parts.push(`<span class="tour-stop-name">${name}</span>`);
                    if (category) {
                        parts.push(`<span class="tour-stop-category">${category}</span>`);
                    }
                    parts.push('</div>');
                    if (address) {
                        parts.push(`<p class="tour-stop-address">${address}</p>`);
                    }
                    parts.push('</div>');
                    parts.push('</li>');
                    if (index < stops.length - 1 && segments[index]) {
                        const seg = segments[index];
                        const segDuration = seg.duration || '';
                        const segDistance = seg.distance || '';
                        let segText = '';
                        if (segDuration && segDistance) {
                            segText = `${segDuration} (${segDistance})`;
                        } else if (segDuration) {
                            segText = segDuration;
                        }
                        if (segText) {
                            parts.push(`<li class="tour-segment-info" aria-label="Walking time to next stop"><span class="segment-arrow">↓</span> ${escapeHtml(segText)}</li>`);
                        }
                    }
                });
                parts.push('</ol>');
            } else {
                parts.push('<p class="tour-detail-empty">This tour has no stops yet.</p>');
            }

            parts.push('</div>');

            parts.push('<div class="location-detail-actions">');
            parts.push('<div class="location-detail-action-row">');
            parts.push(`<button type="button" class="bookmark-btn tour-detail-bookmark" data-tour-id="${tour.id}" data-bookmarked="${isBookmarked}" aria-label="${isBookmarked ? 'Remove bookmark for ' : 'Bookmark '}${escapeHtml(tour.name || 'this tour')}" title="${isBookmarked ? 'Remove bookmark' : 'Add bookmark'}">`);
            parts.push(`<svg class="bookmark-icon${isBookmarked ? ' bookmarked' : ''}" width="20" height="20" viewBox="0 0 24 24" fill="${isBookmarked ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>`);
            parts.push(`<span class="bookmark-label">${isBookmarked ? 'Bookmarked' : 'Bookmark'}</span>`);
            parts.push('</button>');
            if (editUrl) {
                parts.push(`<a class="location-detail-navigate-btn tour-edit-btn" href="${escapeHtml(editUrl)}">Edit this tour</a>`);
            }
            parts.push('</div>');
            parts.push('</div>');
            parts.push('</article>');

            tourDetailContent.innerHTML = parts.join('');

            // Attach bookmark handler to the detail bookmark button
            const detailBookmarkBtn = tourDetailContent.querySelector('.tour-detail-bookmark');
            if (detailBookmarkBtn) {
                attachTourBookmarkHandler(detailBookmarkBtn);
            }
        }

        async function handleTourBookmarkClick(event) {
            event.preventDefault();
            event.stopPropagation();

            const button = event.currentTarget;
            const tourId = button.dataset.tourId;

            if (!tourId) {
                return;
            }

            const wasBookmarked = button.dataset.bookmarked === 'true';
            const nextState = !wasBookmarked;

            // Optimistic UI update
            updateTourBookmarkUI(tourId, nextState, { sourceButton: button });

            try {
                const response = await fetch(`/campus/api/tours/${tourId}/bookmark/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/json',
                    },
                });

                if (!response.ok) {
                    throw new Error('Failed to toggle tour bookmark');
                }
            } catch (error) {
                console.error('Error toggling tour bookmark:', error);
                // Revert optimistic update on error
                updateTourBookmarkUI(tourId, wasBookmarked, { sourceButton: button });
            }
        }

        function reorderTourCards() {
            if (!tourContainer) return;

            const cards = Array.from(tourContainer.querySelectorAll('.tour-card'));
            const bookmarkedCards = cards.filter((card) => card.dataset.bookmarked === 'true');
            const unbookmarkedCards = cards.filter((card) => card.dataset.bookmarked !== 'true');

            // Sort unbookmarked cards by name
            unbookmarkedCards.sort((a, b) => {
                const nameA = a.dataset.tourName || '';
                const nameB = b.dataset.tourName || '';
                return nameA.localeCompare(nameB);
            });

            tourContainer.innerHTML = '';
            bookmarkedCards.forEach((card) => tourContainer.appendChild(card));
            unbookmarkedCards.forEach((card) => tourContainer.appendChild(card));
        }

        function updateTourBookmarkUI(tourId, isBookmarked, { sourceButton } = {}) {
            const bookmarkValue = isBookmarked ? 'true' : 'false';

            // Update tour card in sidebar
            const card = tourContainer?.querySelector(`.tour-card[data-tour-id="${tourId}"]`);
            if (card) {
                card.dataset.bookmarked = bookmarkValue;
                const cardButton = card.querySelector('.sidebar-tour-bookmark');
                if (cardButton) {
                    cardButton.dataset.bookmarked = bookmarkValue;
                    cardButton.title = isBookmarked ? 'Remove bookmark' : 'Add bookmark';
                    const cardIcon = cardButton.querySelector('.bookmark-icon');
                    if (cardIcon) {
                        cardIcon.classList.toggle('bookmarked', isBookmarked);
                        cardIcon.setAttribute('fill', isBookmarked ? 'currentColor' : 'none');
                    }
                }

                // Move bookmarked card to top
                if (isBookmarked && tourContainer.firstChild !== card) {
                    tourContainer.insertBefore(card, tourContainer.firstChild);
                }
            }

            // Update detail view button if open
            const detailButton = tourDetailContent?.querySelector('.tour-detail-bookmark');
            if (detailButton) {
                detailButton.dataset.bookmarked = bookmarkValue;
                detailButton.title = isBookmarked ? 'Remove bookmark' : 'Add bookmark';
                const detailIcon = detailButton.querySelector('.bookmark-icon');
                if (detailIcon) {
                    detailIcon.classList.toggle('bookmarked', isBookmarked);
                    detailIcon.setAttribute('fill', isBookmarked ? 'currentColor' : 'none');
                }
                const label = detailButton.querySelector('.bookmark-label');
                if (label) {
                    label.textContent = isBookmarked ? 'Bookmarked' : 'Bookmark';
                }
            }

            reorderTourCards();
        }

        function attachTourBookmarkHandler(button) {
            if (!button || button.dataset.bookmarkAttached === 'true') {
                return;
            }

            button.addEventListener('click', handleTourBookmarkClick);
            button.dataset.bookmarkAttached = 'true';
        }

        async function showTourDetail(tourId) {
            if (!tourListView || !tourDetailView || !tourDetailContent) {
                return;
            }

            if (!Number.isFinite(tourId)) {
                return;
            }

            if (tourCreateBtn) {
                tourCreateBtn.hidden = true;
                tourCreateBtn.setAttribute('aria-hidden', 'true');
                tourCreateBtn.style.display = 'none';
            }

            if (tourDetailBack) {
                tourDetailBack.hidden = false;
                tourDetailBack.setAttribute('aria-hidden', 'false');
            }

            if (tourListView) {
                tourListView.hidden = true;
                tourListView.setAttribute('aria-hidden', 'true');
                tourListView.style.display = 'none';
            }

            if (tourListHeader) {
                tourListHeader.style.display = 'none';
            }

            if (tourSection) {
                tourSection.classList.add('detail-view-active');
            }

            tourDetailView.hidden = false;
            tourDetailView.setAttribute('aria-hidden', 'false');
            tourDetailView.dataset.activeTourId = String(tourId);
            tourDetailView.scrollTop = 0;
            tourDetailView.style.display = '';
            tourDetailContent.innerHTML = '<p class="sidebar-support-text">Loading tour details…</p>';

            try {
                const tour = await displayTourOnMap(tourId);
                if (!tour) {
                    tourDetailContent.innerHTML = '<p class="sidebar-empty">Unable to load this tour.</p>';
                    return;
                }
                renderTourDetail(tour);
                (tourDetailBack && !tourDetailBack.hidden ? tourDetailBack : null)?.focus();
            } catch (error) {
                console.error('Error loading tour', error);
                tourDetailContent.innerHTML = '<p class="sidebar-empty">Something went wrong while loading this tour.</p>';
            }
        }

        function openTourCard(card) {
            const tourId = parseInt(card.dataset.tourId, 10);
            if (!Number.isFinite(tourId)) {
                return;
            }
            lastFocusedTourCard = card;
            currentTourCard = card;
            showTourDetail(tourId);
        }

        function attachCardHandlers() {
            if (!tourContainer) {
                return;
            }

            const cards = Array.from(tourContainer.querySelectorAll('.tour-card'));
            cards.forEach((card) => {
                if (card.dataset.tourHandlerAttached === 'true') {
                    return;
                }
                card.dataset.tourHandlerAttached = 'true';

                // Attach bookmark handler to the bookmark button in this card
                const bookmarkBtn = card.querySelector('.sidebar-tour-bookmark');
                if (bookmarkBtn) {
                    attachTourBookmarkHandler(bookmarkBtn);
                }

                card.addEventListener('click', (event) => {
                    if (event.defaultPrevented) {
                        return;
                    }
                    // Don't open card if clicking on bookmark button
                    if (event.target.closest('.tour-bookmark-btn')) {
                        return;
                    }
                    openTourCard(card);
                });

                card.addEventListener('keydown', (event) => {
                    const key = event.key;
                    if (key === 'Enter' || key === ' ' || key === 'Spacebar') {
                        event.preventDefault();
                        openTourCard(card);
                    }
                });
            });
        }

        async function displayTourOnMap(tourId) {
            if (!map) {
                alert('Map is not ready. Please wait a moment and try again.');
                return null;
            }

            let tour;
            try {
                tour = await getTourById(tourId);
            } catch (error) {
                console.error('Error fetching tours', error);
                return null;
            }

            if (!tour || !Array.isArray(tour.stops) || tour.stops.length === 0) {
                alert('Tour not found or has no stops.');
                return null;
            }

            clearTourRoute();

            const sortedStops = [...tour.stops].sort((a, b) => a.order - b.order);
            sortedStops.forEach((stop, index) => {
                if (stop.location) {
                    createNumberedMarker(
                        {
                            lat: stop.location.latitude,
                            lng: stop.location.longitude,
                        },
                        index + 1,
                        stop.location.name || `Stop ${index + 1}`
                    );
                }
            });

            if (sortedStops.length === 1) {
                const loneStop = sortedStops[0];
                map.setCenter({
                    lat: loneStop.location.latitude,
                    lng: loneStop.location.longitude,
                });
                map.setZoom(18);
                currentTourData = { ...tour, stops: sortedStops };
                currentSegmentIndex = 0;
                showingAllSegments = true;
                setNavControlsVisibility(false);
                updateSegmentIndicator();
                return tour;
            }

            currentTourData = { ...tour, stops: sortedStops };
            currentSegmentIndex = 0;
            showingAllSegments = true;

            if (tour.route_data && Array.isArray(tour.route_data.segments) && tour.route_data.segments.length > 0) {
                segmentPolylines = tour.route_data.segments.map((segment) => new google.maps.Polyline({
                    path: google.maps.geometry.encoding.decodePath(segment.polyline),
                    strokeColor: '#0066cc',
                    strokeWeight: 4,
                    strokeOpacity: 0.5,
                    map,
                }));

                showAllSegments({ fitBounds: true });
                setNavControlsVisibility(true);
            } else {
                fitMapToTour(sortedStops);
                setNavControlsVisibility(false);
                updateSegmentIndicator();
                alert('Route data not available for this tour. Please edit and save the tour again.');
            }

            updateSegmentIndicator();
            return tour;
        }

        if (tourDetailBack) {
            tourDetailBack.addEventListener('click', () => {
                showTourList({ clearRoute: true });
                tourCreateBtn?.focus();
            });
        }

        attachCardHandlers();

        const toursApi = {
            showTourList,
            clearTourRoute,
            displayTourOnMap,
            showTourDetail,
            refreshTourList,
            addTourCard,
        };
        window.campusTours = toursApi;

        function initTourFunctionality() {
            ensureNavControls();
            attachCardHandlers();
        }

        if (typeof window.initCampusMap !== 'undefined') {
            const originalInit = window.initCampusMap;
            window.initCampusMap = function () {
                originalInit();
                setTimeout(initTourFunctionality, 400);
            };
        } else {
            window.addEventListener('load', () => {
                setTimeout(initTourFunctionality, 400);
            });
        }
    })();
</script>
{% if google_maps_api_key %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&libraries=places,geometry&callback=initCampusMap" async defer></script>
{% endif %}
{% endblock %}
