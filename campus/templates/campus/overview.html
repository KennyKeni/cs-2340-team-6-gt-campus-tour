{% extends "base.html" %}

{% block title %}Campus Overview | GT Tour{% endblock %}

{% block content %}
<div class="campus-layout">
    <section class="panel side-panel" aria-labelledby="explore-heading">
        <header id="explore-heading" class="panel-heading">Explore Georgia Tech</header>
        <div class="sidebar-controls">
            <label class="visually-hidden" for="sidebar-view">Select view</label>
            <select id="sidebar-view" class="sidebar-select" aria-label="Choose content to display">
                <option value="locations" selected>Locations</option>
                <option value="tours">Tours</option>
            </select>
            <div class="sidebar-search">
                <label class="visually-hidden" for="location-search">Search locations</label>
                <input id="location-search" type="search" placeholder="Search locations..." autocomplete="off">
            </div>
        </div>
        <div id="location-list-section" class="sidebar-content" aria-live="polite">
            <p class="sidebar-support-text">Browse campus highlights and tap markers on the map to learn more.</p>
            <div id="location-items" class="location-list">
                {% for location in locations %}
                <article class="location-card"
                    data-name="{{ location.name|lower }}"
                    data-category="{{ location.category|default_if_none:''|lower }}"
                    data-address="{{ location.address|default_if_none:''|lower }}"
                    data-description="{{ location.description|lower }}"
                    data-slug="{{ location.slug }}">
                    <div class="location-header">
                        <div class="location-info">
                            <h3 class="location-title">{{ location.name }}</h3>
                            <p class="location-meta">{{ location.category|default:"Campus Highlight" }}</p>
                        </div>
                        {% if user.is_authenticated %}
                        <button class="bookmark-btn" 
                                data-slug="{{ location.slug }}" 
                                data-bookmarked="{% if location.slug in bookmarked_slugs %}true{% else %}false{% endif %}"
                                aria-label="{% if location.slug in bookmarked_slugs %}Remove bookmark for {{ location.name }}{% else %}Bookmark {{ location.name }}{% endif %}"
                                title="{% if location.slug in bookmarked_slugs %}Remove bookmark{% else %}Add bookmark{% endif %}">
                            <svg class="bookmark-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path class="bookmark-outline" d="M19 21L12 16L5 21V5C5 4.46957 5.21071 3.96086 5.58579 3.58579C5.96086 3.21071 6.46957 3 7 3H17C17.5304 3 18.0391 3.21071 18.4142 3.58579C18.7893 3.96086 19 4.46957 19 5V21Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path class="bookmark-fill" d="M19 21L12 16L5 21V5C5 4.46957 5.21071 3.96086 5.58579 3.58579C5.96086 3.21071 6.46957 3 7 3H17C17.5304 3 18.0391 3.21071 18.4142 3.58579C18.7893 3.96086 19 4.46957 19 5V21Z" fill="currentColor"/>
                            </svg>
                        </button>
                        {% endif %}
                    </div>
                </article>
                {% endfor %}
            </div>
            <p id="location-empty" class="sidebar-empty" hidden>No locations match your search.</p>
        </div>
        <div id="tour-list-section" class="sidebar-content" aria-live="polite" hidden>
            <p class="sidebar-placeholder">Guided tours are coming soon. Stay tuned for curated itineraries!</p>
        </div>
    </section>
    <section class="panel map-panel" aria-labelledby="map-heading">
        <header id="map-heading" class="panel-heading">Campus Map</header>
        {% if not google_maps_api_key %}
        <div style="padding: 1rem;">
            <p>Map unavailable: missing Google Maps API key.</p>
        </div>
        {% endif %}
        <div id="campus-map" class="map-canvas" role="application" aria-label="Georgia Tech campus map">
        </div>
    </section>
    <section class="panel chat-panel" aria-labelledby="chat-heading">
        <header id="chat-heading" class="panel-heading">Ask About Landmarks</header>
        <div id="chat-history" class="chat-history" aria-live="polite">
        </div>
        <form id="chat-form" class="chat-input" novalidate>
            <label for="chat-message" class="visually-hidden">Ask a question about campus landmarks</label>
            <textarea id="chat-message" name="message" placeholder="Ask about a building or landmark..." required></textarea>
            <button type="submit" id="chat-submit">Send</button>
        </form>
    </section>
</div>
{% endblock %}

{% block extra_body %}
{{ locations_payload|json_script:"initial-location-data" }}
{{ map_center|json_script:"map-center-data" }}
<script>
    const locationData = JSON.parse(document.getElementById('initial-location-data').textContent);
    const mapCenter = JSON.parse(document.getElementById('map-center-data').textContent);
    let map;

    function createInfoWindowContent(location) {
        const addressLine = location.address ? `<p><strong>Address:</strong> ${location.address}</p>` : '';
        const categoryLine = location.category ? `<p><strong>Category:</strong> ${location.category}</p>` : '';
        
        // Photo display with graceful degradation
        const photoSection = location.photo_url ? 
            `<div style="margin-bottom: 0.75rem;">
                <img src="${location.photo_url}" 
                     alt="${location.name}" 
                     style="width: 100%; max-width: 250px; height: auto; border-radius: 6px; object-fit: cover;"
                     onerror="this.style.display='none';" />
            </div>` : '';
        
        // Historical information section
        const historicalSection = location.historical_info ? 
            `<div style="margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid #e5e7eb;">
                <h4 style="margin: 0 0 0.5rem; font-size: 0.9rem; color: #6b7280;">Historical Information</h4>
                <p style="margin: 0; font-size: 0.85rem; line-height: 1.4;">${location.historical_info}</p>
            </div>` : '';
        
        return `
            <div style="max-width: 280px;">
                <h3 style="margin: 0 0 0.5rem; font-size: 1.1rem;">${location.name}</h3>
                ${photoSection}
                ${categoryLine}
                ${addressLine}
                <p style="margin: 0.5rem 0;">${location.description}</p>
                ${historicalSection}
            </div>
        `;
    }

    window.initCampusMap = function initCampusMap() {
        const mapElement = document.getElementById('campus-map');
        if (!mapElement) {
            return;
        }
        const adjustedCenter = {
            lat: mapCenter.lat - 0.0015,
            lng: mapCenter.lng,
        };

        map = new google.maps.Map(mapElement, {
            center: adjustedCenter,
            zoom: 17,
            disableDefaultUI: true,
            zoomControl: false,
            streetViewControl: false,
            fullscreenControl: false,
            mapTypeControl: false,
            draggable: false,
            scrollwheel: false,
            disableDoubleClickZoom: true,
            keyboardShortcuts: false,
            gestureHandling: 'none',
            styles: [
                { featureType: 'poi', elementType: 'labels.icon', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi', elementType: 'labels.text', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi', elementType: 'geometry', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi.business', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi.park', stylers: [{ visibility: 'off' }] },
                { featureType: 'poi.school', stylers: [{ visibility: 'off' }] },
                { featureType: 'transit', stylers: [{ visibility: 'off' }] },
            ],
        });

        const infoWindow = new google.maps.InfoWindow();

        locationData.forEach((location) => {
            const marker = new google.maps.Marker({
                position: { lat: location.latitude, lng: location.longitude },
                map,
                title: location.name,
                icon: {
                    path: google.maps.SymbolPath.CIRCLE,
                    scale: 7,
                    fillColor: '#fbbf24',
                    fillOpacity: 1,
                    strokeColor: '#003057',
                    strokeWeight: 2,
                },
            });

            marker.addListener('click', () => {
                infoWindow.setContent(createInfoWindowContent(location));
                infoWindow.open(map, marker);
            });
        });
    };
</script>
<script>
    (function () {
        const viewSelect = document.getElementById('sidebar-view');
        const searchInput = document.getElementById('location-search');
        const locationSection = document.getElementById('location-list-section');
        const toursSection = document.getElementById('tour-list-section');
        const emptyState = document.getElementById('location-empty');
        const locationItems = Array.from(document.querySelectorAll('#location-items .location-card'));

        if (!viewSelect || !searchInput) {
            return;
        }

        function applyFilter() {
            const query = searchInput.value.trim().toLowerCase();
            let visibleCount = 0;

            locationItems.forEach((item) => {
                const haystack = [
                    item.dataset.name,
                    item.dataset.category,
                    item.dataset.address,
                    item.dataset.description,
                ].join(' ');

                const matches = !query || haystack.includes(query);
                item.hidden = !matches;
                if (matches) {
                    visibleCount += 1;
                }
            });

            emptyState.hidden = visibleCount > 0;
        }

        function toggleView() {
            const view = viewSelect.value;

            if (view === 'locations') {
                locationSection.hidden = false;
                toursSection.hidden = true;
                searchInput.disabled = false;
                searchInput.placeholder = 'Search locations...';
                applyFilter();
            } else {
                locationSection.hidden = true;
                toursSection.hidden = false;
                searchInput.value = '';
                searchInput.disabled = true;
                searchInput.placeholder = 'Search disabled for tours';
                emptyState.hidden = true;
            }
        }

        viewSelect.addEventListener('change', toggleView);
        searchInput.addEventListener('input', applyFilter);

        toggleView();
    })();
</script>
<script>
    (function () {
        const storageKey = 'campusChatHistory';
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-message');
        const chatSubmit = document.getElementById('chat-submit');
        const chatHistoryEl = document.getElementById('chat-history');
        const chatEndpoint = "{% url 'campus:chat' %}";
        let typingEl = null;

        function persistHistory(history) {
            try {
                localStorage.setItem(storageKey, JSON.stringify(history));
            } catch (error) {
                console.warn('Unable to persist chat history', error);
            }
        }

        function loadHistory() {
            try {
                const raw = localStorage.getItem(storageKey);
                if (!raw) {
                    return [];
                }
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (error) {
                console.warn('Unable to load chat history', error);
                return [];
            }
        }

        function createMessageElement(entry) {
            const message = document.createElement('div');
            message.classList.add('chat-message', entry.role === 'assistant' ? 'assistant' : 'user');
            message.textContent = entry.content;
            return message;
        }

        function showTypingIndicator() {
            if (typingEl) {
                return;
            }
            typingEl = document.createElement('div');
            typingEl.className = 'chat-message assistant typing';
            const indicator = document.createElement('span');
            indicator.className = 'typing-indicator';
            indicator.innerHTML = 'Thinking<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
            typingEl.appendChild(indicator);
            chatHistoryEl.appendChild(typingEl);
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }

        function hideTypingIndicator() {
            if (!typingEl) {
                return;
            }
            typingEl.remove();
            typingEl = null;
        }

        function renderHistory(history) {
            chatHistoryEl.innerHTML = '';
            history.forEach((entry) => {
                chatHistoryEl.appendChild(createMessageElement(entry));
            });
            chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
        }

        async function sendMessage(event) {
            event.preventDefault();
            const content = chatInput.value.trim();
            if (!content) {
                return;
            }

            const history = loadHistory();
            const userEntry = { role: 'user', content };
            const updatedHistory = [...history, userEntry];

            renderHistory(updatedHistory);
            persistHistory(updatedHistory);

            showTypingIndicator();

            chatInput.value = '';
            chatInput.disabled = true;
            chatSubmit.disabled = true;
            chatSubmit.setAttribute('aria-disabled', 'true');

            try {
                const response = await fetch(chatEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: content,
                        history,
                    }),
                });

                const data = await response.json();
                hideTypingIndicator();
                const reply = data.reply || data.error || 'Sorry, something went wrong.';
                const assistantEntry = { role: 'assistant', content: reply };
                const finalHistory = [...updatedHistory, assistantEntry];
                renderHistory(finalHistory);
                persistHistory(finalHistory);
            } catch (error) {
                console.error('Chat failed', error);
                hideTypingIndicator();
                const assistantEntry = {
                    role: 'assistant',
                    content: 'I could not reach the campus assistant. Please try again shortly.',
                };
                const failedHistory = [...updatedHistory, assistantEntry];
                renderHistory(failedHistory);
                persistHistory(failedHistory);
            } finally {
                chatInput.disabled = false;
                chatSubmit.disabled = false;
                chatSubmit.setAttribute('aria-disabled', 'false');
                chatInput.focus();
            }
        }

        const initialHistory = loadHistory();
        renderHistory(initialHistory);

        chatForm.addEventListener('submit', sendMessage);
    })();

    // Bookmark functionality
    {% if user.is_authenticated %}
    (function() {
        // Handle bookmark button clicks
        document.addEventListener('click', async function(e) {
            if (e.target.closest('.bookmark-btn')) {
                const bookmarkBtn = e.target.closest('.bookmark-btn');
                const slug = bookmarkBtn.dataset.slug;
                const isBookmarked = bookmarkBtn.dataset.bookmarked === 'true';
                
                try {
                    // Get CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                                    document.querySelector('meta[name=csrf-token]')?.getAttribute('content');
                    
                    const response = await fetch(`/api/locations/${slug}/bookmark/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken,
                        },
                        credentials: 'same-origin'
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        
                        // Update button state
                        bookmarkBtn.dataset.bookmarked = data.bookmarked ? 'true' : 'false';
                        bookmarkBtn.setAttribute('aria-label', 
                            data.bookmarked ? `Remove bookmark for ${bookmarkBtn.closest('.location-card').querySelector('.location-title').textContent}` :
                                            `Bookmark ${bookmarkBtn.closest('.location-card').querySelector('.location-title').textContent}`);
                        bookmarkBtn.setAttribute('title', 
                            data.bookmarked ? 'Remove bookmark' : 'Add bookmark');
                        
                        // Re-sort location list if needed
                        setTimeout(() => {
                            sortLocationsByBookmarks();
                        }, 100);
                        
                    } else {
                        console.error('Failed to toggle bookmark');
                    }
                } catch (error) {
                    console.error('Error toggling bookmark:', error);
                }
            }
        });
        
        // Function to sort locations by bookmark status
        function sortLocationsByBookmarks() {
            const locationList = document.getElementById('location-items');
            const locationCards = Array.from(locationList.querySelectorAll('.location-card'));
            
            locationCards.sort((a, b) => {
                const aBookmarked = a.querySelector('.bookmark-btn')?.dataset.bookmarked === 'true';
                const bBookmarked = b.querySelector('.bookmark-btn')?.dataset.bookmarked === 'true';
                const aName = a.querySelector('.location-title').textContent;
                const bName = b.querySelector('.location-title').textContent;
                
                // Bookmarked items first, then alphabetical
                if (aBookmarked && !bBookmarked) return -1;
                if (!aBookmarked && bBookmarked) return 1;
                return aName.localeCompare(bName);
            });
            
            // Re-append sorted cards
            locationCards.forEach(card => locationList.appendChild(card));
        }
    })();
    {% endif %}
</script>
{% if google_maps_api_key %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initCampusMap" async defer></script>
{% endif %}
{% endblock %}
