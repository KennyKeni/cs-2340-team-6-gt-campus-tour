{% extends "base.html" %}

{% block title %}{% if is_edit %}Edit Tour{% else %}Create Tour{% endif %} | GT Tour{% endblock %}

{% block extra_head %}
<style>
    body {
        overflow: auto !important;
    }
    main {
        overflow-y: auto !important;
        overflow-x: hidden !important;
        height: auto !important;
        min-height: calc(100vh - 80px);
    }
</style>
{% endblock %}

{% block content %}
<div class="tour-create-container">
    <header class="tour-create-header">
        <h1>{% if is_edit %}Edit Tour{% else %}Create New Tour{% endif %}</h1>
        <a href="{% url 'campus:tour-manage' %}" class="back-link">← Back to My Tours</a>
    </header>

    <div class="tour-layout">
        <div class="locations-panel">
            <h2>Available Locations</h2>
            <div class="search-box">
                <input type="search" id="location-search" placeholder="Search locations by name, category, or description..." autocomplete="off">
            </div>
            <div id="location-list" class="location-list"></div>
        </div>

        <div class="tour-form-panel">
            <form id="tour-create-form" class="tour-form">
                {% csrf_token %}
                <div class="form-group">
                    <label for="tour-name">Tour Name *</label>
                    <input type="text" id="tour-name" name="name" required placeholder="Enter tour name...">
                </div>

                <div class="form-group">
                    <label for="tour-description">Description</label>
                    <textarea id="tour-description" name="description" rows="3" placeholder="Describe your tour..."></textarea>
                </div>

                <div class="selected-stops">
                    <h3>Tour Stops <span id="stop-count">(0)</span></h3>
                    <p class="help-text">Drag to reorder, or use up/down buttons</p>
                    <ul id="selected-stops-list" class="stops-list"></ul>
                    <p id="no-stops-message" class="empty-message">No stops added yet. Click locations from the left panel to add them.</p>
                </div>

                <div class="form-actions">
                    <button type="button" id="cancel-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" id="save-btn" class="btn btn-primary" disabled>{% if is_edit %}Update Tour{% else %}Save Tour{% endif %}</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_body %}
{{ locations_payload|json_script:"location-data" }}
{% if tour_payload %}
{{ tour_payload|json_script:"tour-data" }}
{% endif %}
<script>
(function() {
    const locationData = JSON.parse(document.getElementById('location-data').textContent);
    const tourData = document.getElementById('tour-data') ? JSON.parse(document.getElementById('tour-data').textContent) : null;
    const isEdit = {{ is_edit|yesno:"true,false" }};

    const searchInput = document.getElementById('location-search');
    const locationList = document.getElementById('location-list');
    const selectedStopsList = document.getElementById('selected-stops-list');
    const stopCountSpan = document.getElementById('stop-count');
    const noStopsMessage = document.getElementById('no-stops-message');
    const tourForm = document.getElementById('tour-create-form');
    const saveBtn = document.getElementById('save-btn');
    const cancelBtn = document.getElementById('cancel-btn');

    let selectedStops = [];
    let draggedElement = null;

    if (isEdit && tourData) {
        document.getElementById('tour-name').value = tourData.name;
        document.getElementById('tour-description').value = tourData.description || '';
        selectedStops = tourData.stops.map(stop => stop.location);
        renderSelectedStops();
        updateSaveButton();
    }

    function getDefaultLocations() {
        const bookmarked = locationData.filter(loc => loc.is_bookmarked).slice(0, 10);

        if (bookmarked.length >= 10) {
            return bookmarked;
        }

        const sorted = [...locationData].sort((a, b) => a.name.localeCompare(b.name));
        const bookmarkedIds = new Set(bookmarked.map(loc => loc.id));
        const remaining = sorted.filter(loc => !bookmarkedIds.has(loc.id));

        return [...bookmarked, ...remaining].slice(0, 10);
    }

    function filterLocations(query) {
        if (!query.trim()) {
            return getDefaultLocations();
        }

        const lowerQuery = query.toLowerCase();
        return locationData.filter(loc => {
            const haystack = [
                loc.name,
                loc.category || '',
                loc.address || '',
                loc.description
            ].join(' ').toLowerCase();
            return haystack.includes(lowerQuery);
        });
    }

    function renderLocationList(query = '') {
        const results = filterLocations(query);
        const selectedIds = new Set(selectedStops.map(s => s.id));

        locationList.innerHTML = results.map(location => {
            const isSelected = selectedIds.has(location.id);
            const isBookmarked = location.is_bookmarked;

            return `
                <div class="location-card ${isSelected ? 'selected' : ''}" data-location-id="${location.id}">
                    <div class="location-card-content">
                        <div class="location-header">
                            <h4>${location.name}</h4>
                            ${isBookmarked ? '<span class="bookmark-badge">⭐ Bookmarked</span>' : ''}
                        </div>
                        <p class="location-category">${location.category}</p>
                        <p class="location-description">${location.description.substring(0, 80)}${location.description.length > 80 ? '...' : ''}</p>
                    </div>
                    <button type="button" class="btn-add ${isSelected ? 'added' : ''}" data-location-id="${location.id}" ${isSelected ? 'disabled' : ''}>
                        ${isSelected ? '✓ Added' : '+ Add'}
                    </button>
                </div>
            `;
        }).join('');

        locationList.querySelectorAll('.btn-add:not(.added)').forEach(btn => {
            btn.addEventListener('click', function() {
                const locId = parseInt(this.getAttribute('data-location-id'));
                const location = locationData.find(l => l.id === locId);
                if (location && !selectedStops.find(s => s.id === locId)) {
                    selectedStops.push(location);
                    renderSelectedStops();
                    renderLocationList(searchInput.value);
                    updateSaveButton();
                }
            });
        });
    }

    function renderSelectedStops() {
        stopCountSpan.textContent = `(${selectedStops.length})`;

        if (selectedStops.length === 0) {
            selectedStopsList.style.display = 'none';
            noStopsMessage.style.display = 'block';
            return;
        }

        selectedStopsList.style.display = 'block';
        noStopsMessage.style.display = 'none';

        selectedStopsList.innerHTML = selectedStops.map((stop, index) => `
            <li class="stop-item" draggable="true" data-index="${index}">
                <div class="stop-number">${index + 1}</div>
                <div class="stop-info">
                    <strong>${stop.name}</strong>
                    <div class="category">${stop.category}</div>
                </div>
                <div class="stop-actions">
                    <button type="button" class="move-btn" data-action="up" data-index="${index}" ${index === 0 ? 'disabled' : ''}>↑</button>
                    <button type="button" class="move-btn" data-action="down" data-index="${index}" ${index === selectedStops.length - 1 ? 'disabled' : ''}>↓</button>
                    <button type="button" class="remove-btn" data-index="${index}">Remove</button>
                </div>
            </li>
        `).join('');

        selectedStopsList.querySelectorAll('.move-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                const action = this.getAttribute('data-action');
                if (action === 'up' && index > 0) {
                    [selectedStops[index], selectedStops[index - 1]] = [selectedStops[index - 1], selectedStops[index]];
                } else if (action === 'down' && index < selectedStops.length - 1) {
                    [selectedStops[index], selectedStops[index + 1]] = [selectedStops[index + 1], selectedStops[index]];
                }
                renderSelectedStops();
            });
        });

        selectedStopsList.querySelectorAll('.remove-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                selectedStops.splice(index, 1);
                renderSelectedStops();
                renderLocationList(searchInput.value);
                updateSaveButton();
            });
        });

        selectedStopsList.querySelectorAll('.stop-item').forEach(item => {
            item.addEventListener('dragstart', handleDragStart);
            item.addEventListener('dragover', handleDragOver);
            item.addEventListener('drop', handleDrop);
            item.addEventListener('dragend', handleDragEnd);
        });
    }

    function handleDragStart(e) {
        draggedElement = this;
        e.dataTransfer.effectAllowed = 'move';
        this.classList.add('dragging');
    }

    function handleDragOver(e) {
        if (e.preventDefault) {
            e.preventDefault();
        }
        e.dataTransfer.dropEffect = 'move';
        return false;
    }

    function handleDrop(e) {
        if (e.stopPropagation) {
            e.stopPropagation();
        }

        if (draggedElement !== this) {
            const draggedIndex = parseInt(draggedElement.getAttribute('data-index'));
            const targetIndex = parseInt(this.getAttribute('data-index'));

            const draggedStop = selectedStops[draggedIndex];
            selectedStops.splice(draggedIndex, 1);
            selectedStops.splice(targetIndex, 0, draggedStop);

            renderSelectedStops();
        }

        return false;
    }

    function handleDragEnd() {
        this.classList.remove('dragging');
    }

    function updateSaveButton() {
        const hasName = document.getElementById('tour-name').value.trim() !== '';
        const hasStops = selectedStops.length > 0;
        saveBtn.disabled = !(hasName && hasStops);
    }

    searchInput.addEventListener('input', function() {
        renderLocationList(this.value);
    });

    document.getElementById('tour-name').addEventListener('input', updateSaveButton);

    tourForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const name = document.getElementById('tour-name').value.trim();
        const description = document.getElementById('tour-description').value.trim();

        if (!name) {
            alert('Please enter a tour name.');
            return;
        }

        if (selectedStops.length === 0) {
            alert('Please add at least one stop to your tour.');
            return;
        }

        const payload = {
            name: name,
            description: description,
            location_ids: selectedStops.map(stop => stop.id),
        };

        saveBtn.disabled = true;
        saveBtn.textContent = isEdit ? 'Updating...' : 'Saving...';

        try {
            const url = isEdit
                ? `/campus/api/tours/${tourData.id}/`
                : '{% url "campus:tour-list" %}';
            const method = isEdit ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken(),
                },
                body: JSON.stringify(payload),
            });

            if (response.ok) {
                window.location.href = '{% url "campus:tour-manage" %}';
            } else {
                const data = await response.json();
                alert(data.error || `Failed to ${isEdit ? 'update' : 'create'} tour. Please try again.`);
                saveBtn.disabled = false;
                saveBtn.textContent = isEdit ? 'Update Tour' : 'Save Tour';
            }
        } catch (error) {
            console.error(`Error ${isEdit ? 'updating' : 'creating'} tour:`, error);
            alert('An error occurred. Please try again.');
            saveBtn.disabled = false;
            saveBtn.textContent = isEdit ? 'Update Tour' : 'Save Tour';
        }
    });

    cancelBtn.addEventListener('click', function() {
        window.location.href = '{% url "campus:tour-manage" %}';
    });

    function getCsrfToken() {
        const name = 'csrftoken';
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    renderLocationList();
})();
</script>

<style>
.tour-create-container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 2rem;
    min-height: calc(100vh - 100px);
}

.tour-create-header {
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.tour-create-header h1 {
    margin: 0;
    font-size: 2rem;
    color: #003057;
}

.back-link {
    color: #003057;
    text-decoration: none;
    font-weight: 500;
}

.back-link:hover {
    text-decoration: underline;
}

.tour-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    align-items: start;
}

.locations-panel {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    max-height: calc(100vh - 250px);
    display: flex;
    flex-direction: column;
}

.locations-panel h2 {
    margin: 0 0 1rem 0;
    font-size: 1.5rem;
    color: #003057;
}

.search-box {
    margin-bottom: 1rem;
}

.search-box input {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s;
}

.search-box input:focus {
    outline: none;
    border-color: #003057;
}

.location-list {
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.location-card {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: linear-gradient(145deg, #eef2ff, #dbeafe);
    border: 2px solid transparent;
    border-radius: 8px;
    transition: all 0.2s;
}

.location-card:hover:not(.selected) {
    border-color: #003057;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 48, 87, 0.15);
}

.location-card.selected {
    background: #f3f4f6;
    opacity: 0.6;
}

.location-card-content {
    flex: 1;
}

.location-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
}

.location-card h4 {
    margin: 0;
    font-size: 1.1rem;
    color: #003057;
}

.bookmark-badge {
    font-size: 0.75rem;
    padding: 0.125rem 0.5rem;
    background: #fbbf24;
    color: #78350f;
    border-radius: 12px;
    font-weight: 600;
}

.location-category {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0.25rem 0;
    font-weight: 500;
}

.location-description {
    font-size: 0.875rem;
    color: #4b5563;
    margin: 0.5rem 0 0 0;
    line-height: 1.4;
}

.btn-add {
    padding: 0.5rem 1rem;
    background: #003057;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.875rem;
    white-space: nowrap;
    transition: background 0.2s;
    align-self: center;
}

.btn-add:hover:not(:disabled) {
    background: #001f3f;
}

.btn-add.added {
    background: #10b981;
    cursor: default;
}

.btn-add:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.tour-form-panel {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: sticky;
    top: 2rem;
}

.tour-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 600;
    color: #374151;
}

.form-group input,
.form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #d1d5db;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s;
}

.form-group input:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #003057;
}

.selected-stops h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
    color: #003057;
}

.help-text {
    font-size: 0.875rem;
    color: #6b7280;
    margin: 0 0 1rem 0;
}

.stops-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.stop-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: linear-gradient(145deg, #fef3c7, #fde68a);
    border: 2px solid rgba(217, 119, 6, 0.18);
    border-radius: 8px;
    cursor: move;
    transition: all 0.2s;
}

.stop-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 48, 87, 0.15);
}

.stop-item.dragging {
    opacity: 0.5;
}

.stop-number {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    background: #003057;
    color: white;
    border-radius: 50%;
    font-weight: 700;
    font-size: 1.1rem;
    flex-shrink: 0;
}

.stop-info {
    flex: 1;
}

.stop-info strong {
    display: block;
    color: #374151;
    font-size: 1rem;
    margin-bottom: 0.25rem;
}

.category {
    font-size: 0.875rem;
    color: #6b7280;
}

.stop-actions {
    display: flex;
    gap: 0.5rem;
}

.move-btn {
    padding: 0.5rem;
    background: white;
    border: 2px solid #d1d5db;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
    width: 32px;
    height: 32px;
}

.move-btn:hover:not(:disabled) {
    background: #f3f4f6;
    border-color: #003057;
}

.move-btn:disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.remove-btn {
    padding: 0.5rem 1rem;
    background: #dc2626;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 600;
    transition: background 0.2s;
}

.remove-btn:hover {
    background: #b91c1c;
}

.empty-message {
    text-align: center;
    padding: 3rem 2rem;
    color: #6b7280;
    background: #f9fafb;
    border-radius: 8px;
    border: 2px dashed #d1d5db;
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding-top: 1.5rem;
    border-top: 2px solid #e5e7eb;
}

.btn {
    padding: 0.75rem 2rem;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.2s;
}

.btn-primary {
    background: #003057;
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background: #001f3f;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 48, 87, 0.3);
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-secondary {
    background: white;
    color: #374151;
    border: 2px solid #d1d5db;
}

.btn-secondary:hover {
    background: #f9fafb;
    border-color: #9ca3af;
}

@media (max-width: 1200px) {
    .tour-layout {
        grid-template-columns: 1fr;
    }

    .tour-form-panel {
        position: static;
    }

    .locations-panel {
        max-height: 500px;
    }
}

@media (max-width: 768px) {
    .tour-create-container {
        padding: 1rem;
    }

    .tour-create-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .location-card {
        flex-direction: column;
    }

    .btn-add {
        width: 100%;
    }
}
</style>
{% endblock %}
