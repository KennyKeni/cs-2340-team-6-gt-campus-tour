{% extends "base.html" %}

{% block title %}{{ location.name }} | GT Tour{% endblock %}

{% block extra_head %}
<style>
body {
    overflow: auto !important;
}
main {
    overflow: visible !important;
}
</style>
{% endblock %}

{% block content %}
<div class="location-detail-container" style="max-width: 1200px; margin: 0 auto; padding: 2rem;">
    <div class="location-header" style="margin-bottom: 2rem;">
        <div style="display: flex; justify-content: space-between; align-items: start;">
            <div>
                <h1 style="margin: 0 0 0.5rem 0;">{{ location.name }}</h1>
                {% if location.category %}
                <p style="color: #666; margin: 0;"><strong>Category:</strong> {{ location.category }}</p>
                {% endif %}
                <div class="average-rating-display" style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <span id="avg-stars" style="color: #fbbf24; font-size: 1.25rem;">
                        {% if average_rating %}
                            {% for i in "12345" %}{% if forloop.counter <= average_rating %}&#9733;{% else %}&#9734;{% endif %}{% endfor %}
                        {% else %}
                            &#9734;&#9734;&#9734;&#9734;&#9734;
                        {% endif %}
                    </span>
                    <span id="avg-text" style="color: #666; font-size: 0.875rem;">
                        {% if average_rating %}{{ average_rating }} ({{ rating_count }} rating{{ rating_count|pluralize }}){% else %}No ratings yet{% endif %}
                    </span>
                </div>
            </div>
            {% if user.is_authenticated %}
            <button class="bookmark-btn"
                    data-slug="{{ location.slug }}"
                    style="padding: 0.75rem 1.5rem; background: #003057; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;">
                <svg class="bookmark-icon {% if is_bookmarked %}bookmarked{% endif %}"
                     width="20" height="20" viewBox="0 0 24 24"
                     fill="{% if is_bookmarked %}currentColor{% else %}none{% endif %}"
                     stroke="currentColor" stroke-width="2"
                     style="vertical-align: middle; margin-right: 0.5rem;">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                </svg>
                <span>{% if is_bookmarked %}Bookmarked{% else %}Bookmark{% endif %}</span>
            </button>
            {% endif %}
        </div>
    </div>

    <div class="location-content" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <div class="location-info">
            {% if location.photo or location.image_url %}
            <div class="location-photo" style="margin-bottom: 2rem;">
                <img src="{% if location.photo %}{{ location.photo.url }}{% else %}{{ location.image_url }}{% endif %}"
                     alt="{{ location.name }}"
                     style="width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                     onerror="this.parentElement.style.display='none';">
            </div>
            {% endif %}

            <div class="description" style="margin-bottom: 2rem;">
                <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">About</h2>
                <p style="line-height: 1.6; color: #333;">{{ location.description }}</p>
            </div>

            {% if location.address %}
            <div class="address" style="margin-bottom: 2rem;">
                <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">Location</h2>
                <p style="line-height: 1.6; color: #333;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 0.5rem;">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                    {{ location.address }}
                </p>
            </div>
            {% endif %}

            <div class="actions" style="margin-top: 2rem;">
                <a href="{% url 'campus:overview' %}" style="display: inline-block; padding: 0.75rem 1.5rem; background: #f0f0f0; color: #333; text-decoration: none; border-radius: 4px; margin-right: 1rem;">
                    ← Back to Map
                </a>
                {% if location.latitude and location.longitude %}
                <a href="{% url 'campus:overview' %}?navigate={{ location.slug }}"
                   style="display: inline-block; padding: 0.75rem 1.5rem; background: #003057; color: white; text-decoration: none; border-radius: 4px;">
                    Get Directions →
                </a>
                {% endif %}
            </div>
        </div>

        <div class="location-map">
            {% if google_maps_api_key %}
            <div id="detail-map" style="width: 100%; height: 500px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>
            {% else %}
            <div style="padding: 2rem; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <p>Map unavailable: missing Google Maps API key.</p>
            </div>
            {% endif %}
        </div>
    </div>

    {% if location.historical_info %}
    <div class="historical-info" style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-left: 4px solid #003057; border-radius: 4px;">
        <h2 style="font-size: 1.5rem; margin-bottom: 1rem; color: #003057;">Historical Information</h2>
        <p style="line-height: 1.6; color: #333; white-space: pre-line;">{{ location.historical_info }}</p>
    </div>
    {% endif %}

    {% if user.is_authenticated %}
    <div class="rating-section" style="margin-bottom: 2rem; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
        <h2 style="font-size: 1.5rem; margin-bottom: 1rem;">{% if user_rating %}Your Review{% else %}Rate This Location{% endif %}</h2>

        {% if user_rating %}
        <div id="existing-rating" style="margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.75rem;">
                <span id="user-rating-stars" style="color: #fbbf24; font-size: 1.25rem;">
                    {% for i in "12345" %}
                        {% if forloop.counter <= user_rating.score %}&#9733;{% else %}&#9734;{% endif %}
                    {% endfor %}
                </span>
                <span style="color: #666; font-size: 0.875rem;">{{ user_rating.created_at|date:"M d, Y" }}</span>
                <span style="padding: 0.25rem 0.75rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
                    {% if user_rating.status == 'new' %}background: #fef3c7; color: #92400e;
                    {% elif user_rating.status == 'reviewed' %}background: #dbeafe; color: #1e40af;
                    {% else %}background: #d1fae5; color: #065f46;{% endif %}">
                    {{ user_rating.get_status_display }}
                </span>
            </div>
            <p id="user-rating-comment" style="line-height: 1.6; color: #333; margin-bottom: 1rem;">{% if user_rating.comment %}{{ user_rating.comment }}{% endif %}</p>

            {% if user_rating.admin_response %}
            <div style="margin-top: 1rem; padding: 1rem; background: #e0f2fe; border-radius: 8px; border-left: 4px solid #0284c7;">
                <h3 style="font-size: 1rem; margin: 0 0 0.5rem 0; color: #0369a1;">Admin Response</h3>
                <p style="line-height: 1.6; color: #333; margin: 0 0 0.5rem 0;">{{ user_rating.admin_response }}</p>
                <span style="font-size: 0.75rem; color: #666;">
                    Responded by {{ user_rating.responded_by.username }} on {{ user_rating.responded_at|date:"M d, Y" }}
                </span>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <div id="rating-form" style="{% if user_rating %}border-top: 1px solid #ddd; padding-top: 1rem; margin-top: 1rem;{% endif %}">
            <p style="margin-bottom: 0.75rem; color: #666;">{% if user_rating %}Update your rating:{% else %}Click to rate:{% endif %}</p>
            <div class="star-input" style="display: flex; gap: 0.25rem; margin-bottom: 1rem;">
                {% for i in "12345" %}
                <button type="button" class="star-btn" data-value="{{ forloop.counter }}"
                        style="background: none; border: none; cursor: pointer; font-size: 2rem; color: #ddd; padding: 0; transition: color 0.1s;">
                    &#9733;
                </button>
                {% endfor %}
            </div>
            <input type="hidden" id="selected-rating" value="{% if user_rating %}{{ user_rating.score }}{% else %}0{% endif %}">

            <div style="margin-bottom: 1rem;">
                <label for="rating-comment" style="display: block; margin-bottom: 0.5rem; color: #666;">Comment (optional):</label>
                <textarea id="rating-comment" rows="3" placeholder="Share your experience..."
                          style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; font-size: 0.875rem; resize: vertical;">{% if user_rating %}{{ user_rating.comment }}{% endif %}</textarea>
            </div>

            <button type="button" id="submit-rating-btn"
                    style="padding: 0.75rem 1.5rem; background: #003057; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;">
                {% if user_rating %}Update Review{% else %}Submit Review{% endif %}
            </button>
        </div>
    </div>
    {% endif %}
</div>

<style>
.bookmark-btn:hover {
    background: #002244 !important;
}
.bookmark-icon.bookmarked {
    fill: #fbbf24;
}
.star-btn:hover,
.star-btn.hovered {
    color: #fbbf24 !important;
}
.star-btn.selected {
    color: #fbbf24 !important;
}
#submit-rating-btn:hover {
    background: #002244 !important;
}
#submit-rating-btn:disabled {
    background: #ccc !important;
    cursor: not-allowed;
}
</style>

<script>
{% if google_maps_api_key %}
window.initDetailMap = function() {
    const map = new google.maps.Map(document.getElementById('detail-map'), {
        center: { lat: {{ location.latitude }}, lng: {{ location.longitude }} },
        zoom: 17,
        styles: [
            { featureType: 'poi', elementType: 'labels.icon', stylers: [{ visibility: 'off' }] },
            { featureType: 'poi', elementType: 'labels.text', stylers: [{ visibility: 'off' }] },
        ],
    });

    new google.maps.Marker({
        position: { lat: {{ location.latitude }}, lng: {{ location.longitude }} },
        map: map,
        title: '{{ location.name }}',
        icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10,
            fillColor: '#fbbf24',
            fillOpacity: 1,
            strokeColor: '#003057',
            strokeWeight: 3,
        },
    });
};
{% endif %}

// Bookmark toggle functionality
{% if user.is_authenticated %}
document.querySelector('.bookmark-btn').addEventListener('click', async function(e) {
    e.preventDefault();

    const slug = this.dataset.slug;
    const icon = this.querySelector('.bookmark-icon');
    const text = this.querySelector('span');
    const isBookmarked = icon.classList.contains('bookmarked');

    try {
        const response = await fetch(`/campus/api/locations/${slug}/bookmark/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json',
            },
        });

        if (response.ok) {
            icon.classList.toggle('bookmarked');
            if (isBookmarked) {
                icon.setAttribute('fill', 'none');
                text.textContent = 'Bookmark';
            } else {
                icon.setAttribute('fill', 'currentColor');
                text.textContent = 'Bookmarked';
            }
        }
    } catch (error) {
        console.error('Error toggling bookmark:', error);
    }
});

// Rating functionality
const starBtns = document.querySelectorAll('.star-btn');
const selectedRatingInput = document.getElementById('selected-rating');
const submitBtn = document.getElementById('submit-rating-btn');
const ratingComment = document.getElementById('rating-comment');

let selectedRating = parseInt(selectedRatingInput.value) || 0;

function updateStarDisplay(rating, isHover = false) {
    starBtns.forEach((btn, index) => {
        if (index < rating) {
            btn.classList.add(isHover ? 'hovered' : 'selected');
            if (!isHover) btn.classList.remove('hovered');
        } else {
            btn.classList.remove(isHover ? 'hovered' : 'selected');
            if (!isHover) btn.classList.remove('hovered');
        }
    });
}

updateStarDisplay(selectedRating);

starBtns.forEach(btn => {
    btn.addEventListener('mouseenter', function() {
        const value = parseInt(this.dataset.value);
        updateStarDisplay(value, true);
    });

    btn.addEventListener('mouseleave', function() {
        updateStarDisplay(0, true);
        updateStarDisplay(selectedRating);
    });

    btn.addEventListener('click', function() {
        selectedRating = parseInt(this.dataset.value);
        selectedRatingInput.value = selectedRating;
        updateStarDisplay(selectedRating);
    });
});

submitBtn.addEventListener('click', async function() {
    if (selectedRating < 1 || selectedRating > 5) {
        showToast('Please select a rating (1-5 stars)', 'error');
        return;
    }

    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    try {
        const response = await fetch('/campus/api/locations/{{ location.slug }}/rate/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            },
            body: JSON.stringify({
                score: selectedRating,
                comment: ratingComment.value.trim(),
            }),
        });

        const data = await response.json();

        if (response.ok && data.success) {
            showToast(data.created ? 'Review submitted!' : 'Review updated!', 'success');

            const avgStars = document.getElementById('avg-stars');
            const avgText = document.getElementById('avg-text');
            if (data.average_rating) {
                let starsHtml = '';
                for (let i = 1; i <= 5; i++) {
                    starsHtml += i <= data.average_rating ? '&#9733;' : '&#9734;';
                }
                avgStars.innerHTML = starsHtml;
                avgText.textContent = `${data.average_rating} (${data.rating_count} rating${data.rating_count !== 1 ? 's' : ''})`;
            }

            const sectionTitle = document.querySelector('.rating-section h2');
            if (sectionTitle) sectionTitle.textContent = 'Your Review';

            submitBtn.textContent = 'Update Review';
        } else {
            showToast(data.error || 'Failed to submit rating', 'error');
        }
    } catch (error) {
        console.error('Error submitting rating:', error);
        showToast('An error occurred. Please try again.', 'error');
    } finally {
        submitBtn.disabled = false;
        if (submitBtn.textContent === 'Submitting...') {
            submitBtn.textContent = '{% if user_rating %}Update Review{% else %}Submit Review{% endif %}';
        }
    }
});
{% endif %}
</script>

{% if google_maps_api_key %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initDetailMap" async defer></script>
{% endif %}

{% endblock %}
